<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantacalcio 2025 - Ultra Intelligence</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #9333ea 100%);
            height: 100vh;
            min-height: 100dvh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
            color: white;
            padding: clamp(10px, 4vw, 30px);
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .nav-tabs {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .nav-btn {
            padding: 8px 16px;
            border-radius: 12px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
        }

        .nav-btn.active {
            background: white;
            color: #2563eb;
            font-weight: bold;
        }

        #targets-view {
            display: none;
            padding: clamp(10px, 4vw, 30px);
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .search-container {
            padding: clamp(10px, 4vw, 30px);
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .search-box {
            position: relative;
            max-width: 600px;
            margin: 0 auto;
        }

        .search-input {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.1rem;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #2563eb;
            background: white;
            color: #2563eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .filter-btn.active {
            background: #2563eb;
            color: white;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            padding: clamp(10px, 4vw, 30px);
        }

        .players-grid {
            display: grid;
            gap: 20px;
        }

        .role-section {
            background: white;
            border-radius: 12px;
            padding: clamp(10px, 4vw, 30px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .role-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f3f4;
        }

        .role-icon {
            font-size: 2rem;
            margin-right: 15px;
        }

        .role-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .role-count {
            margin-left: auto;
            background: #2563eb;
            color: white;
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
        }

        .player-card {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
            border-left: 4px solid transparent;
        }

        .player-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left-color: #2563eb;
        }

        .player-card.bought {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .player-card.bought-elsewhere {
            opacity: 0.6;
            background: #e9ecef;
        }

        .player-actions {
            display: flex;
            gap: 6px;
            margin-left: 10px;
        }

        .action-btn {
            border: none;
            background: #2563eb;
            color: white;
            padding: 6px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .purchase-badge {
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 4px;
            display: inline-block;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .player-team {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .player-stats {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .stat-badge {
            background: #e9ecef;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            color: #495057;
        }

        .stat-badge.excellent { background: #d4edda; color: #155724; }
        .stat-badge.good { background: #fff3cd; color: #856404; }
        .stat-badge.average { background: #f8d7da; color: #721c24; }

        .player-price {
            text-align: center;
            margin-left: 15px;
        }

        .smart-price {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2563eb;
            margin-bottom: 5px;
        }

        .price-range {
            font-size: 0.8rem;
            color: #666;
        }

        .opportunity-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .sidebar {
            background: white;
            border-radius: 12px;
            padding: clamp(10px, 4vw, 30px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-card {
            background: #fff;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .sidebar-card-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .sidebar-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .quick-stat {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .quick-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2563eb;
        }

        .quick-stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        .recommendations {
            list-style: none;
        }

        .recommendation {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 10px;
            border-left: 3px solid #28a745;
        }

        .recommendation-text {
            font-size: 0.9rem;
            color: #333;
        }

        .recommendation-price {
            font-weight: bold;
            color: #28a745;
            margin-top: 3px;
        }

        .slots-planner {
            width: 100%;
            border-collapse: collapse;
        }

        .slots-planner th, .slots-planner td {
            padding: 4px;
            text-align: center;
            font-size: 0.8rem;
        }

        .slot-input {
            width: 40px;
        }

        .slot-input,
        #strategy-P,
        #strategy-D,
        #strategy-C,
        #strategy-A {
            -webkit-appearance: none;
            margin: 0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: clamp(10px, 4vw, 30px);
            }

            .sidebar {
                order: -1;
                position: static;
            }

            .header h1 {
                font-size: 2rem;
            }

            .stats-overview {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8rem;
            }
            .header .subtitle {
                font-size: 1rem;
            }
            .filters {
                gap: 6px;
            }
            .main-content {
                gap: 20px;
            }
        }

        .advanced-filters {
            background: white;
            padding: clamp(10px, 4vw, 30px);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 150px;
        }

        .filter-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .filter-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 12px;
            background: white;
        }

        .price-range-slider {
            margin-top: 10px;
        }

        .range-input {
            width: 100%;
            margin-bottom: 5px;
        }

        .range-values {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #666;
        }

        .ai-insights {
            background: linear-gradient(135deg, #2563eb 0%, #9333ea 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .insight-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .insight-text {
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100vh;
            min-height: 100dvh;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            margin: 0;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            height: auto;
            max-height: calc(100dvh - 2rem);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #333;
        }

        .player-details {
            display: grid;
            gap: 20px;
        }

        .detail-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
        }

        .detail-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .price-analysis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .source-price {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 12px;
            border: 1px solid #ddd;
        }

        .source-name {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 5px;
        }

        .source-value {
            font-weight: bold;
            color: #2563eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Fantacalcio 2025</h1>
            <div class="subtitle">Ultra-Intelligent Database & Smart Pricing</div>
            <div class="nav-tabs">
                <button id="nav-home" class="nav-btn active">Lista</button>
                <button id="nav-targets" class="nav-btn">Targets</button>
            </div>
            <div class="stats-overview">
                <div class="stat-card">
                    <div class="stat-value" id="total-players">465</div>
                    <div class="stat-label">Giocatori Totali</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">4</div>
                    <div class="stat-label">Fonti Dati</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">2</div>
                    <div class="stat-label">Stagioni</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avg-consensus">86%</div>
                    <div class="stat-label">Consenso Medio</div>
                </div>
            </div>
        </div>

        <div id="main-view">
        <div class="search-container">
            <div class="search-box">
                <input type="text" class="search-input" placeholder="🔍 Cerca giocatori... (nome, team, stats)"
                       id="search-input">
            </div>
            <div class="filters" id="role-filters">
                <button class="filter-btn active" data-role="all">Tutti</button>
                <button class="filter-btn" data-role="P">🥅 Portieri</button>
                <button class="filter-btn" data-role="D">🛡️ Difensori</button>
                <button class="filter-btn" data-role="C">⚡ Centrocampisti</button>
                <button class="filter-btn" data-role="A">⚔️ Attaccanti</button>
            </div>
        </div>

        <div class="main-content">
            <div class="players-section">
                <div class="advanced-filters">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label class="filter-label">Fascia di Prezzo</label>
                            <select class="filter-select" id="price-filter">
                                <option value="all">Tutte le fasce</option>
                                <option value="top">Top (40+)</option>
                                <option value="semitop">Semitop (20-40)</option>
                                <option value="mid">Media (10-20)</option>
                                <option value="low">Low Cost (1-10)</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Affidabilità</label>
                            <select class="filter-select" id="reliability-filter">
                                <option value="all">Tutte</option>
                                <option value="5">⭐⭐⭐⭐⭐</option>
                                <option value="4">⭐⭐⭐⭐</option>
                                <option value="3">⭐⭐⭐</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Opportunità</label>
                            <select class="filter-select" id="opportunity-filter">
                                <option value="all">Tutte</option>
                                <option value="high">🔥 Alta</option>
                                <option value="medium">📈 Media</option>
                                <option value="low">⚖️ Equilibrio</option>
                            </select>
                        </div>
                    </div>
                    <div class="price-range-slider">
                        <label class="filter-label">Range di Prezzo</label>
                        <input type="range" class="range-input" id="min-price" min="1" max="200" value="1">
                        <input type="range" class="range-input" id="max-price" min="1" max="200" value="200">
                        <div class="range-values">
                            <span id="min-price-val">1</span>
                            <span id="max-price-val">200</span>
                        </div>
                    </div>
                </div>

                <div class="players-grid" id="players-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        Caricamento database intelligente...
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="sidebar-section">
                    <div class="sidebar-title">💰 Budget</div>
                    <button id="open-strategy" class="action-btn" style="width: 100%; margin-top: 10px;">📐 Strategia</button>
                    <div id="strategy-container" style="display: none; margin-top: 10px;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px;">
                            <label>P: <input type="number" id="strategy-P" min="0" max="100" style="width:60px;"></label>
                            <label>D: <input type="number" id="strategy-D" min="0" max="100" style="width:60px;"></label>
                            <label>C: <input type="number" id="strategy-C" min="0" max="100" style="width:60px;"></label>
                            <label>A: <input type="number" id="strategy-A" min="0" max="100" style="width:60px;"></label>
                        </div>
                        <button id="save-strategy" class="action-btn" style="width:100%;">Salva</button>
                    </div>
                    <ul class="recommendations">
                        <li>Totale: <span id="budget-total">0</span>/<span id="budget-total-max">500</span></li>
                        <li>P: <span id="budget-P">0</span>/<span id="budget-P-max">50</span> (<span id="count-P">0</span>/<span id="needed-P">3</span>)</li>
                        <li>D: <span id="budget-D">0</span>/<span id="budget-D-max">160</span> (<span id="count-D">0</span>/<span id="needed-D">8</span>)</li>
                        <li>C: <span id="budget-C">0</span>/<span id="budget-C-max">150</span> (<span id="count-C">0</span>/<span id="needed-C">8</span>)</li>
                        <li>A: <span id="budget-A">0</span>/<span id="budget-A-max">140</span> (<span id="count-A">0</span>/<span id="needed-A">6</span>)</li>
                    </ul>
                </div>

                <details class="sidebar-card">
                    <summary class="sidebar-card-title">🤖 AI Insights</summary>
                    <div class="insight-text" id="ai-insight">
                        Analizzando le tendenze di mercato e le performance storiche...
                    </div>
                </details>

                <details class="sidebar-card" open>
                    <summary class="sidebar-card-title">💎 Opportunità Top</summary>
                    <ul class="recommendations" id="top-opportunities">
                        <li class="recommendation">
                            <div class="recommendation-text">Caricamento opportunità...</div>
                        </li>
                    </ul>
                </details>
            </div>
        </div>
        </div>

        <div id="targets-view">
            <h2 style="text-align:center; margin:20px 0;">Squad Planner</h2>
            <table class="slots-planner" id="squad-planner">
                <tr>
                    <th>R</th><th>1</th><th>2</th><th>3</th><th>4</th>
                </tr>
                <tr>
                    <td>P</td>
                    <td><input type="number" class="slot-input" id="slot-plan-P-1" min="0" value="0"> <small id="slot-count-P-1">0/0</small></td>
                    <td><input type="number" class="slot-input" id="slot-plan-P-2" min="0" value="0"> <small id="slot-count-P-2">0/0</small></td>
                    <td><input type="number" class="slot-input" id="slot-plan-P-3" min="0" value="0"> <small id="slot-count-P-3">0/0</small></td>
                    <td><input type="number" class="slot-input" id="slot-plan-P-4" min="0" value="0"> <small id="slot-count-P-4">0/0</small></td>
                </tr>
                <tr>
                    <td>D</td>
                    <td><input type="number" class="slot-input" id="slot-plan-D-1" min="0" value="0"> <small id="slot-count-D-1">0/0</small></td>
                    <td><input type="number" class="slot-input" id="slot-plan-D-2" min="0" value="0"> <small id="slot-count-D-2">0/0</small></td>
                    <td><input type="number" class="slot-input" id="slot-plan-D-3" min="0" value="0"> <small id="slot-count-D-3">0/0</small></td>
                    <td><input type="number" class="slot-input" id="slot-plan-D-4" min="0" value="0"> <small id="slot-count-D-4">0/0</small></td>
                </tr>
                <tr>
                    <td>C</td>
                    <td><input type="number" class="slot-input" id="slot-plan-C-1" min="0" value="0"> <small id="slot-count-C-1">0/0</small></td>
                    <td><input type="number" class="slot-input" id="slot-plan-C-2" min="0" value="0"> <small id="slot-count-C-2">0/0</small></td>
                    <td><input type="number" class="slot-input" id="slot-plan-C-3" min="0" value="0"> <small id="slot-count-C-3">0/0</small></td>
                    <td><input type="number" class="slot-input" id="slot-plan-C-4" min="0" value="0"> <small id="slot-count-C-4">0/0</small></td>
                </tr>
                <tr>
                    <td>A</td>
                    <td><input type="number" class="slot-input" id="slot-plan-A-1" min="0" value="0"> <small id="slot-count-A-1">0/0</small></td>
                    <td><input type="number" class="slot-input" id="slot-plan-A-2" min="0" value="0"> <small id="slot-count-A-2">0/0</small></td>
                    <td><input type="number" class="slot-input" id="slot-plan-A-3" min="0" value="0"> <small id="slot-count-A-3">0/0</small></td>
                    <td><input type="number" class="slot-input" id="slot-plan-A-4" min="0" value="0"> <small id="slot-count-A-4">0/0</small></td>
                </tr>
            </table>
            <div class="players-grid" id="targets-grid"></div>
        </div>
    </div>

    <!-- Player Detail Modal -->
    <div id="player-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="player-details"></div>
        </div>
    </div>

    <script>
        // 🔥 DYNAMIC ULTRA-INTELLIGENT DATABASE
        let PLAYERS_DB = {};
        // Global variables
        let currentRole = 'all';
        let searchTerm = '';
        let currentFilters = {
            price: 'all',
            reliability: 'all',
            opportunity: 'all',
            minPrice: 1,
            maxPrice: 200
        };

        // Budget and target tracking
        const budget = {
            total: { max: 500, spent: 0 },
            roles: {
                'P': { max: 50, spent: 0, count: 0, needed: 3 },
                'D': { max: 160, spent: 0, count: 0, needed: 8 },
                'C': { max: 150, spent: 0, count: 0, needed: 8 },
                'A': { max: 140, spent: 0, count: 0, needed: 6 }
            }
        };
        const strategy = {};
        const targets = JSON.parse(localStorage.getItem('targets') || '{}');
        const purchased = {};
        const others = {};
        const slotTypes = ['1', '2', '3', '4'];
        const slotPlan = {
            'P': { '1': 0, '2': 0, '3': 0, '4': 0 },
            'D': { '1': 0, '2': 0, '3': 0, '4': 0 },
            'C': { '1': 0, '2': 0, '3': 0, '4': 0 },
            'A': { '1': 0, '2': 0, '3': 0, '4': 0 }
        };
        const slotPurchases = {
            'P': { '1': 0, '2': 0, '3': 0, '4': 0 },
            'D': { '1': 0, '2': 0, '3': 0, '4': 0 },
            'C': { '1': 0, '2': 0, '3': 0, '4': 0 },
            'A': { '1': 0, '2': 0, '3': 0, '4': 0 }
        };

        function loadPurchased() {
            const saved = JSON.parse(localStorage.getItem('purchased') || '{}');
            Object.entries(saved).forEach(([key, data]) => {
                const [role, name] = key.split(':');
                const slot = data.slot || targets[key]?.slot || '4';
                purchased[key] = { ...data, slot };
                budget.total.spent += data.price;
                budget.roles[role] = budget.roles[role] || { spent: 0, count: 0 };
                budget.roles[role].spent += data.price;
                budget.roles[role].count += 1;
                slotPurchases[role][slot] = (slotPurchases[role][slot] || 0) + 1;
                targets[key] = targets[key] || { name, role, price: data.price, slot };
                targets[key].slot = targets[key].slot || slot;
                targets[key].price = data.price;
            });
            const othersSaved = JSON.parse(localStorage.getItem('others') || '{}');
            Object.entries(othersSaved).forEach(([key, data]) => {
                const [role, name] = key.split(':');
                others[key] = { name, role };
            });
            savePurchased();
            saveOthers();
        }

        function savePurchased() {
            localStorage.setItem('purchased', JSON.stringify(purchased));
        }

        function saveOthers() {
            localStorage.setItem('others', JSON.stringify(others));
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadPurchased();
            updateBudgetUI();
            updateTargetsUI();
            const playersGrid = document.getElementById('players-grid');
            fetch('players_database.json')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    PLAYERS_DB = data;
                    initializeApp();
                    setupEventListeners();
                    renderPlayers();
                    generateAIInsights();
                })
                .catch(error => {
                    console.error('Error loading player database:', error);
                    if (playersGrid) {
                        playersGrid.innerHTML = '<div class="error">Errore nel caricamento dei dati</div>';
                    }
                });
        });

        function initializeApp() {
            // Calculate total players
            const totalPlayers = Object.values(PLAYERS_DB).reduce((sum, role) => sum + role.length, 0);
            document.getElementById('total-players').textContent = totalPlayers;

            // Initialize range sliders
            document.getElementById('min-price').addEventListener('input', updatePriceRange);
            document.getElementById('max-price').addEventListener('input', updatePriceRange);
            ['P','D','C','A'].forEach(role => {
                strategy[role] = Math.round((budget.roles[role].max / budget.total.max) * 100);
                const input = document.getElementById(`strategy-${role}`);
                if (input) input.value = strategy[role];
            });
            updateBudgetUI();
            updateTargetsUI();
        }

        function setupEventListeners() {
            // Search input
            document.getElementById('search-input').addEventListener('input', handleSearch);
            
            // Role filters
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', handleRoleFilter);
            });
            
            // Advanced filters
            document.getElementById('price-filter').addEventListener('change', handleAdvancedFilter);
            document.getElementById('reliability-filter').addEventListener('change', handleAdvancedFilter);
            document.getElementById('opportunity-filter').addEventListener('change', handleAdvancedFilter);
            
            // Modal
            const modal = document.getElementById('player-modal');
            const closeModal = modal.querySelector('.close');
            closeModal.addEventListener('click', () => modal.style.display = 'none');

            window.addEventListener('click', (e) => {
                if (e.target === modal) modal.style.display = 'none';
            });

            setupSquadPlanner();
        }

        function setupSquadPlanner() {
            ['P','D','C','A'].forEach(role => {
                slotTypes.forEach(slot => {
                    const input = document.getElementById(`slot-plan-${role}-${slot}`);
                    if (input) {
                        input.addEventListener('input', e => {
                            slotPlan[role][slot] = parseInt(e.target.value) || 0;
                            updateBudgetUI();
                            updateTargetsUI();
                        });
                    }
                });
            });
        }

        // Strategy inputs toggle
        const strategyContainer = document.getElementById('strategy-container');
        document.getElementById('open-strategy').addEventListener('click', () => {
            if (strategyContainer.style.display === 'none' || strategyContainer.style.display === '') {
                strategyContainer.style.display = 'block';
            } else {
                strategyContainer.style.display = 'none';
            }
        });
        document.getElementById('save-strategy').addEventListener('click', saveStrategy);

        // Navigation
        document.getElementById('nav-home').addEventListener('click', showMainView);
        document.getElementById('nav-targets').addEventListener('click', showTargetsView);

        function handleSearch(e) {
            searchTerm = e.target.value.toLowerCase();
            renderPlayers();
        }

        function handleRoleFilter(e) {
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            
            currentRole = e.target.dataset.role;
            renderPlayers();
        }

        function handleAdvancedFilter() {
            currentFilters.price = document.getElementById('price-filter').value;
            currentFilters.reliability = document.getElementById('reliability-filter').value;
            currentFilters.opportunity = document.getElementById('opportunity-filter').value;
            renderPlayers();
        }

        function showMainView() {
            document.getElementById('main-view').style.display = 'block';
            document.getElementById('targets-view').style.display = 'none';
            document.getElementById('nav-home').classList.add('active');
            document.getElementById('nav-targets').classList.remove('active');
            renderPlayers();
        }

        function showTargetsView() {
            document.getElementById('main-view').style.display = 'none';
            document.getElementById('targets-view').style.display = 'block';
            document.getElementById('nav-home').classList.remove('active');
            document.getElementById('nav-targets').classList.add('active');
            updateTargetsUI();
        }

        function updatePriceRange() {
            const minPrice = parseInt(document.getElementById('min-price').value);
            const maxPrice = parseInt(document.getElementById('max-price').value);
            
            // Ensure min doesn't exceed max
            if (minPrice > maxPrice) {
                document.getElementById('min-price').value = maxPrice;
                currentFilters.minPrice = maxPrice;
            } else {
                currentFilters.minPrice = minPrice;
            }
            
            currentFilters.maxPrice = maxPrice;
            
            document.getElementById('min-price-val').textContent = currentFilters.minPrice;
            document.getElementById('max-price-val').textContent = currentFilters.maxPrice;
            
            renderPlayers();
        }

        function decodePlayer(playerArray, role) {
            // Decode player data structure based on role
            const baseData = {
                nome: playerArray[0],
                team: playerArray[1],
                prezzi: {
                    min: playerArray[2][0],
                    max: playerArray[2][1],
                    avg: playerArray[2][2]
                },
                stats: playerArray[3],
                fascia: role === 'P' ? playerArray[5] : (role === 'D' ? playerArray[5] : playerArray[6]),
                allPrices: role === 'P' ? playerArray[6] : (role === 'D' ? playerArray[6] : playerArray[8])
            };

            // Add role-specific advanced stats
            if (role === 'P') {
                baseData.advanced = playerArray[4];
            } else if (role === 'D') {
                baseData.advanced = playerArray[4];
            } else if (role === 'C' || role === 'A') {
                baseData.performance = playerArray[4];
                baseData.discipline = playerArray[5];
                baseData.notes = playerArray[7];
            }

            return baseData;
        }

        function filterPlayers(players, role) {
            return players.filter(playerArray => {
                const player = decodePlayer(playerArray, role);
                
                // Search filter
                if (searchTerm) {
                    const searchStr = `${player.nome} ${player.team}`.toLowerCase();
                    if (!searchStr.includes(searchTerm)) return false;
                }
                
                // Price range filter
                const avgPrice = player.prezzi.avg;
                if (avgPrice < currentFilters.minPrice || avgPrice > currentFilters.maxPrice) return false;
                
                // Price tier filter
                if (currentFilters.price !== 'all') {
                    const priceMatches = {
                        'top': avgPrice >= 40,
                        'semitop': avgPrice >= 20 && avgPrice < 40,
                        'mid': avgPrice >= 10 && avgPrice < 20,
                        'low': avgPrice < 10
                    };
                    if (!priceMatches[currentFilters.price]) return false;
                }
                
                // Reliability filter
                if (currentFilters.reliability !== 'all') {
                    const reliability = player.stats.a || 3;
                    if (reliability !== parseInt(currentFilters.reliability)) return false;
                }
                
                // Opportunity filter (based on price variance)
                if (currentFilters.opportunity !== 'all') {
                    const variance = ((player.prezzi.max - player.prezzi.min) / player.prezzi.avg) * 100;
                    const opportunityMatches = {
                        'high': variance > 20,
                        'medium': variance >= 10 && variance <= 20,
                        'low': variance < 10
                    };
                    if (!opportunityMatches[currentFilters.opportunity]) return false;
                }
                
                return true;
            });
        }

        function getOpportunityLevel(player) {
            const variance = ((player.prezzi.max - player.prezzi.min) / player.prezzi.avg) * 100;
            if (variance > 20) return 'high';
            if (variance >= 10) return 'medium';
            return 'low';
        }

        function getReliabilityStars(reliability) {
            return '⭐'.repeat(reliability || 3);
        }

        function formatStatBadge(value, thresholds = [4, 3]) {
            if (value >= thresholds[0]) return 'excellent';
            if (value >= thresholds[1]) return 'good';
            return 'average';
        }

        function findPlayer(name, role) {
            const players = PLAYERS_DB[role] || [];
            const playerArray = players.find(p => p[0] === name);
            return playerArray ? decodePlayer(playerArray, role) : null;
        }

        function calculateTargetPrices(player, role) {
            const roleData = budget.roles[role];
            const remainingBudget = roleData.max - roleData.spent;
            const remainingSlots = roleData.needed - roleData.count;
            const perSlot = remainingSlots > 0 ? Math.floor(remainingBudget / remainingSlots) : 0;
            return {
                ideal: Math.min(player.prezzi.min, perSlot),
                suggested: Math.min(player.prezzi.avg, perSlot),
                max: Math.min(player.prezzi.max, remainingBudget)
            };
        }

        function updateSmartPricing() {
            const remainingTotal = budget.total.max - budget.total.spent;
            ['P','D','C','A'].forEach(role => {
                budget.roles[role].max = budget.roles[role].spent + Math.round(remainingTotal * (strategy[role] || 0) / 100);
            });
            Object.keys(targets).forEach(key => {
                const t = targets[key];
                const player = findPlayer(t.name, t.role);
                if (player) {
                    t.prices = calculateTargetPrices(player, t.role);
                }
            });
            updateBudgetUI();
            updateTargetsUI();
        }

        function saveStrategy() {
            const total = budget.total.max;
            let newTotal = 0;
            ['P','D','C','A'].forEach(role => {
                const val = parseInt(document.getElementById(`strategy-${role}`).value) || 0;
                strategy[role] = val;
                const roleMax = Math.round(total * val / 100);
                budget.roles[role].max = roleMax;
                newTotal += roleMax;
            });
            budget.total.max = newTotal;
            updateBudgetUI();
            updateSmartPricing();
            strategyContainer.style.display = 'none';
        }

        function updateBudgetUI() {
            document.getElementById('budget-total').textContent = budget.total.spent;
            document.getElementById('budget-total-max').textContent = budget.total.max;
            ['P','D','C','A'].forEach(role => {
                document.getElementById(`budget-${role}`).textContent = budget.roles[role].spent;
                document.getElementById(`budget-${role}-max`).textContent = budget.roles[role].max;
                document.getElementById(`count-${role}`).textContent = budget.roles[role].count;
                document.getElementById(`needed-${role}`).textContent = budget.roles[role].needed;
                slotTypes.forEach(slot => {
                    const span = document.getElementById(`slot-count-${role}-${slot}`);
                    if (span) {
                        span.textContent = `${slotPurchases[role][slot]}/${slotPlan[role][slot]}`;
                    }
                });
            });
        }

        function getRemainingSlotQuota(role, slot) {
            return Math.max((slotPlan[role][slot] || 0) - (slotPurchases[role][slot] || 0), 0);
        }

        function checkSlotAlert(role, slot) {
            if (getRemainingSlotQuota(role, slot) <= 0) {
                alert(`Quota slot ${slot} per ruolo ${role} raggiunta`);
            }
        }

        function calculateTargetPrices() {
            const slotBudgets = {};
            ['P','D','C','A'].forEach(role => {
                slotBudgets[role] = {};
                const total = Object.values(slotPlan[role]).reduce((a, b) => a + parseInt(b || 0), 0);
                slotTypes.forEach(slot => {
                    slotBudgets[role][slot] = total ? budget.roles[role].max * (slotPlan[role][slot] || 0) / total : 0;
                });
            });

            Object.values(targets).forEach(t => {
                const slotBudget = slotBudgets[t.role]?.[t.slot] || 0;
                const plannedCount = slotPlan[t.role]?.[t.slot] || 1;
                t.targetPrice = Math.round(slotBudget / plannedCount);
            });

            return slotBudgets;
        }

        function updateTargetsUI() {
            localStorage.setItem('targets', JSON.stringify(targets));

            // Render grid (if present)
            const container = document.getElementById('targets-grid');
            if (container) {
                const roleIcons = { 'P': '🥅', 'D': '🛡️', 'C': '⚡', 'A': '⚔️' };
                const grouped = { 'P': [], 'D': [], 'C': [], 'A': [] };
                Object.entries(targets).forEach(([key, t]) => {
                    grouped[t.role].push([key, t]);
                });
                let html = '';
                ['P','D','C','A'].forEach(role => {
                    if (!grouped[role].length) return;
                    html += `<h3>${roleIcons[role] ?? role}</h3>`;
                    grouped[role].forEach(([key, t]) => {
                        const purchasedInfo = purchased[key];
                        const othersInfo = others[key];
                        const price = purchasedInfo?.price ?? t.price;
                        const boughtClass = purchasedInfo ? 'bought' : '';
                        const externalClass = othersInfo ? 'bought-elsewhere' : '';
                        html += `
                        <div class="player-card ${boughtClass} ${externalClass}">
                            <div class="player-info">
                                <div class="player-name">${roleIcons[role] ?? ''} ${t.name}</div>
                                <div class="player-team">Ruolo: ${role} • Slot 
                                    <select class="slot-select" data-key="${key}" data-role="${role}">
                                        ${slotTypes.map(s => `<option value="${s}" ${t.slot == s ? 'selected' : ''}>${s}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div class="player-price">
                                <div class="smart-price">€${price}</div>
                            </div>
                            <div class="player-actions">
                                <button class="action-btn" onclick="toggleTarget('${t.name}', '${role}', ${t.price})">❌</button>
                                <button class="action-btn" onclick="editTarget('${key}')">✏️</button>
                                <button class="action-btn" onclick="promptBuyPlayer('${t.name}', ${price}, '${role}')">💸</button>
                                <button class="action-btn" onclick="${othersInfo ? `unmarkBoughtElsewhere('${t.name}', '${role}')` : `markBoughtElsewhere('${t.name}', '${role}')`}">🚫</button>
                                ${purchasedInfo ? `<button class="action-btn" onclick="unbuyPlayer('${t.name}', '${role}')">🔄</button><span class=\"purchase-badge\">€${purchasedInfo.price}</span>` : ''}
                            </div>
                        </div>`;
                    });
                });
                container.innerHTML = html || '<p>Nessun obiettivo selezionato</p>';
                container.querySelectorAll('.slot-select').forEach(sel => {
                    sel.addEventListener('change', e => {
                        const key = e.target.dataset.key;
                        const role = e.target.dataset.role;
                        const prevSlot = targets[key].slot;
                        const newSlot = e.target.value;
                        targets[key].slot = newSlot;
                        if (purchased[key]) {
                            slotPurchases[role][prevSlot] = Math.max((slotPurchases[role][prevSlot] || 0) - 1, 0);
                            slotPurchases[role][newSlot] = (slotPurchases[role][newSlot] || 0) + 1;
                        }
                        updateBudgetUI();
                        updateTargetsUI();
                    });
                });
            }

            // Render simple list (if present)
            const list = document.getElementById('target-list');
            if (list) {
                calculateTargetPrices();
                const grouped = {};
                Object.values(targets).forEach(t => {
                    if (!grouped[t.slot]) grouped[t.slot] = [];
                    grouped[t.slot].push(t);
                });

                let html = '';
                slotTypes.forEach(slot => {
                    const players = grouped[slot] || [];
                    const remaining = ['P','D','C','A'].map(role => `${role}:${getRemainingSlotQuota(role, slot)}`).join(' ');
                    html += `<li><strong>${slot} (${remaining})</strong></li>`;
                    players.forEach(t => {
                        const key = `${t.role}:${t.name}`;
                        const price = purchased[key]?.price ?? t.price;
                        if (t.prices) {
                            html += `<li class="recommendation" style="margin-left:10px;">${t.name} (${t.role}) - I:${t.prices.ideal} S:${t.prices.suggested} M:${t.prices.max} • €${price}${t.targetPrice ? ` (TP: €${t.targetPrice})` : ''}</li>`;
                        } else {
                            html += `<li class="recommendation" style="margin-left:10px;">${t.name} (${t.role}) - €${price}${t.targetPrice ? ` (TP: €${t.targetPrice})` : ''}</li>`;
                        }
                    });
                });
                list.innerHTML = html;
            }
        }

        function toggleTarget(name, role, price) {
            const key = `${role}:${name}`;
            if (targets[key]) {
                delete targets[key];
                if (others[key]) {
                    delete others[key];
                    saveOthers();
                }
            } else {
                const player = findPlayer(name, role);
                let slot = prompt('Seleziona slot (1-4):', '4');
                if (!slotTypes.includes(slot)) return;
                const prices = player ? calculateTargetPrices(player, role) : undefined;
                targets[key] = prices
                    ? { name, role, price, slot, prices }
                    : { name, role, price, slot };
            }
            updateTargetsUI();
        }

        function promptBuyPlayer(name, defaultPrice, role) {
            const input = prompt(`Prezzo pagato per ${name}?`, defaultPrice);
            const price = parseInt(input, 10);
            if (input === null || input.trim() === '' || isNaN(price)) return;
            buyPlayer(name, price, role);
        }

        function editTarget(key) {
            const target = targets[key];
            if (!target) return;
            const newPrice = prompt('Nuovo prezzo per ' + target.name, target.price);
            if (newPrice !== null && !isNaN(newPrice)) {
                target.price = parseInt(newPrice, 10);
                updateTargetsUI();
            }
        }

        function buyPlayer(name, price, role) {
            const key = `${role}:${name}`;
            if (purchased[key]) return;
            let slot = targets[key]?.slot;
            if (!slot) {
                slot = prompt('Seleziona slot per acquisto (1-4):', '4');
                if (!slotTypes.includes(slot)) slot = '4';
            }
            const player = findPlayer(name, role);
            const hints = player ? calculateTargetPrices(player, role) : { ideal: 0, suggested: 0 };
            purchased[key] = { name, role, price, slot };
            if (others[key]) {
                delete others[key];
                saveOthers();
            }
            budget.total.spent += price;
            budget.roles[role].spent += price;
            budget.roles[role].count += 1;
            slotPurchases[role][slot] += 1;
            updateBudgetUI();
            const el = document.getElementById(`player-${role}-${name.replace(/\s+/g,'-')}`);
            if (el) {
                el.classList.add('bought');
                const actions = el.querySelector('.player-actions');
                let badge = actions.querySelector('.purchase-badge');
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'purchase-badge';
                    actions.appendChild(badge);
                }
                badge.textContent = `€${price}`;
            }
            targets[key] = targets[key] || { name, role, price, slot };
            targets[key].price = price;
            targets[key].slot = targets[key].slot || slot;
            updateTargetsUI();
            checkAlerts(role);
            checkSlotAlert(role, slot);
            if (price < hints.ideal || price < hints.suggested) {
                updateSmartPricing();
            }
            savePurchased();
        }

        function unbuyPlayer(name, role) {
            const key = `${role}:${name}`;
            const info = purchased[key];
            if (!info) return;
            const { price, slot } = info;
            budget.total.spent -= price;
            budget.roles[role].spent -= price;
            budget.roles[role].count -= 1;
            if (slot) {
                slotPurchases[role][slot] = Math.max((slotPurchases[role][slot] || 0) - 1, 0);
            }
            delete purchased[key];
            savePurchased();
            updateBudgetUI();
            const el = document.getElementById(`player-${role}-${name.replace(/\s+/g,'-')}`);
            if (el) {
                el.classList.remove('bought');
                const actions = el.querySelector('.player-actions');
                const badge = actions.querySelector('.purchase-badge');
                if (badge) badge.remove();
            }
            updateTargetsUI();
        }

        function markBoughtElsewhere(name, role) {
            const key = `${role}:${name}`;
            if (others[key]) return;
            others[key] = { name, role };
            saveOthers();
            const el = document.getElementById(`player-${role}-${name.replace(/\s+/g,'-')}`);
            if (el) {
                el.classList.add('bought-elsewhere');
            }
            updateTargetsUI();
        }

        function unmarkBoughtElsewhere(name, role) {
            const key = `${role}:${name}`;
            if (!others[key]) return;
            delete others[key];
            saveOthers();
            const el = document.getElementById(`player-${role}-${name.replace(/\s+/g,'-')}`);
            if (el) {
                el.classList.remove('bought-elsewhere');
            }
            updateTargetsUI();
        }

        function checkAlerts(role) {
            const remaining = budget.roles[role].needed - budget.roles[role].count;
            if (remaining <= 1) {
                alert(`Attenzione! Rimangono ${remaining} giocatori da acquistare nel ruolo ${role}`);
            }
        }

        function createPlayerCard(playerArray, role) {
            const player = decodePlayer(playerArray, role);
            const opportunity = getOpportunityLevel(player);
            const reliabilityStars = getReliabilityStars(player.stats.a);
            const key = `${role}:${player.nome}`;
            const purchasedInfo = purchased[key];
            const othersInfo = others[key];
            const opportunityColors = {
                'high': '#28a745',
                'medium': '#ffc107',
                'low': '#6c757d'
            };

            const roleIcons = {
                'P': '🥅',
                'D': '🛡️',
                'C': '⚡',
                'A': '⚔️'
            };
            const boughtClass = purchasedInfo ? 'bought' : '';
            const externalClass = othersInfo ? 'bought-elsewhere' : '';

            return `
                <div class="player-card ${boughtClass} ${externalClass}" id="player-${role}-${player.nome.replace(/\s+/g,'-')}" onclick="showPlayerDetails('${playerArray[0]}', '${role}')">
                    <div style="position: relative; flex:1;">
                        ${opportunity === 'high' ? '<div class="opportunity-badge">🔥</div>' : ''}
                        <div class="player-info">
                            <div class="player-name">${roleIcons[role]} ${player.nome}</div>
                            <div class="player-team">${player.team} • ${player.fascia}</div>
                            <div class="player-stats">
                                <span class="stat-badge ${formatStatBadge(player.stats.t)}">
                                    Tit: ${player.stats.t || 3}/5
                                </span>
                                <span class="stat-badge ${formatStatBadge(player.stats.a)}">
                                    ${reliabilityStars}
                                </span>
                                <span class="stat-badge ${formatStatBadge(player.stats.i)}">
                                    Salute: ${player.stats.i || 3}/5
                                </span>
                                ${role === 'C' || role === 'A' ? `
                                    <span class="stat-badge ${formatStatBadge(player.performance?.g || 0, [3, 1])}">
                                        ⚽ ${player.performance?.g || 0}
                                    </span>
                                ` : ''}
                                ${role === 'C' || role === 'A' ? `
                                    <span class="stat-badge ${formatStatBadge(player.performance?.as || 0, [2, 1])}">
                                        🅰️ ${player.performance?.as || 0}
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                        <div class="player-price">
                            <div class="smart-price" style="color: ${opportunityColors[opportunity]}">
                                €${player.prezzi.avg}
                            </div>
                            <div class="price-range">
                                €${player.prezzi.min}-${player.prezzi.max}
                            </div>
                        </div>
                    </div>
                    <div class="player-actions">
                        <button class="action-btn" onclick="event.stopPropagation(); toggleTarget('${player.nome}', '${role}', ${player.prezzi.avg})">🎯</button>
                        <button class="action-btn" onclick="event.stopPropagation(); promptBuyPlayer('${player.nome}', ${player.prezzi.avg}, '${role}')">💸</button>
                        ${purchasedInfo ? `<button class="action-btn" onclick="event.stopPropagation(); unbuyPlayer('${player.nome}', '${role}')">🔄</button><span class=\"purchase-badge\">€${purchasedInfo.price}</span>` : ''}
                    </div>
                </div>
            `;
        }

        function renderPlayers() {
            const playersGrid = document.getElementById('players-grid');
            const roles = currentRole === 'all' ? ['P', 'D', 'C', 'A'] : [currentRole];
            
            let allPlayersHtml = '';
            let totalFiltered = 0;

            const roleNames = {
                'P': '🥅 Portieri',
                'D': '🛡️ Difensori', 
                'C': '⚡ Centrocampisti',
                'A': '⚔️ Attaccanti'
            };

            roles.forEach(role => {
                const players = PLAYERS_DB[role] || [];
                const filteredPlayers = filterPlayers(players, role);
                totalFiltered += filteredPlayers.length;

                if (filteredPlayers.length > 0) {
                    allPlayersHtml += `
                        <div class="role-section">
                            <div class="role-header">
                                <div class="role-title">${roleNames[role]}</div>
                                <div class="role-count">${filteredPlayers.length}</div>
                            </div>
                            ${filteredPlayers.map(player => createPlayerCard(player, role)).join('')}
                        </div>
                    `;
                }
            });

            if (totalFiltered === 0) {
                allPlayersHtml = `
                    <div class="role-section">
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 3rem; margin-bottom: 20px;">🔍</div>
                            <div style="font-size: 1.2rem; margin-bottom: 10px;">Nessun risultato trovato</div>
                            <div>Prova a modificare i filtri di ricerca</div>
                        </div>
                    </div>
                `;
            }

            playersGrid.innerHTML = allPlayersHtml;
            updateTopOpportunities();
        }

        function updateTopOpportunities() {
            const MIN_RELIABILITY = 4;
            const opportunities = [];

            Object.entries(PLAYERS_DB).forEach(([role, players]) => {
                players.forEach(playerArray => {
                    const player = decodePlayer(playerArray, role);
                    const opportunity = getOpportunityLevel(player);
                    const variance = ((player.prezzi.max - player.prezzi.min) / player.prezzi.avg) * 100;
                    const reliability = player.stats.a || 0;
                    const recentForm = player.stats.f || 0;
                    const targetPrice = Math.round(player.prezzi.min * 1.1);
                    const savings = Math.round(player.prezzi.avg - targetPrice);

                    if (opportunity === 'high' && reliability >= MIN_RELIABILITY) {
                        opportunities.push({
                            ...player,
                            role,
                            variance,
                            targetPrice,
                            reliability,
                            recentForm,
                            savings
                        });
                    }
                });
            });

            opportunities.sort((a, b) => b.savings - a.savings);

            const topOpportunitiesList = document.getElementById('top-opportunities');
            const roleIcons = { 'P': '🥅', 'D': '🛡️', 'C': '⚡', 'A': '⚔️' };

            topOpportunitiesList.innerHTML = opportunities
                .filter(opp => opp.reliability >= MIN_RELIABILITY)
                .slice(0, 5)
                .map(opp => `
                <li class="recommendation" onclick="showPlayerDetails('${opp.nome}', '${opp.role}')">
                    <div class="recommendation-text">
                        ${roleIcons[opp.role]} ${opp.nome} (${opp.team})
                    </div>
                    <div class="recommendation-price">
                        Target: €${opp.targetPrice} (Risparmio: €${opp.savings}) • Affidabilità: ${opp.reliability}/5 • Forma: ${opp.recentForm.toFixed(2)}
                    </div>
                </li>
            `).join('') || '<li class="recommendation"><div class="recommendation-text">Nessuna opportunità con i filtri attuali</div></li>';
        }

        function generateAIInsights() {
            if (!PLAYERS_DB || Object.keys(PLAYERS_DB).length === 0) {
                document.getElementById('ai-insight').textContent = 'Analisi in corso...';
                setTimeout(generateAIInsights, 10000);
                return;
            }

            const roleIcons = { 'P': '🥅', 'D': '🛡️', 'C': '⚡', 'A': '⚔️' };
            const allPlayers = Object.entries(PLAYERS_DB).flatMap(([role, arr]) =>
                arr.map(pArr => ({ ...decodePlayer(pArr, role), role }))
            );

            const highReliability = allPlayers
                .filter(p => (p.stats?.a || 0) >= 4)
                .sort((a, b) => a.prezzi.avg - b.prezzi.avg);

            const topPlayers = highReliability.slice(0, 3);
            const insightText = topPlayers.length
                ? `Giocatori affidabili a basso costo: ${topPlayers.map(p => `${roleIcons[p.role]} ${p.nome} €${p.prezzi.avg}`).join(', ')}`
                : 'Nessun giocatore affidabile trovato.';

            document.getElementById('ai-insight').textContent = insightText;
            setTimeout(generateAIInsights, 10000);
        }

        function showPlayerDetails(playerName, role) {
            const players = PLAYERS_DB[role] || [];
            const playerArray = players.find(p => p[0] === playerName);
            
            if (!playerArray) return;
            
            const player = decodePlayer(playerArray, role);
            const priceHints = calculateTargetPrices(player, role);
            const modal = document.getElementById('player-modal');
            const detailsContainer = document.getElementById('player-details');

            const roleIcons = { 'P': '🥅', 'D': '🛡️', 'C': '⚡', 'A': '⚔️' };
            
            let detailsHtml = `
                <h2>${roleIcons[role]} ${player.nome}</h2>
                <p style="color: #666; margin-bottom: 20px;">${player.team} • ${player.fascia}</p>
                
                <div class="player-details">
                    <div class="detail-section">
                        <div class="detail-title">💰 Analisi Prezzi Smart</div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #dc3545;">€${player.prezzi.min}</div>
                                <div style="font-size: 0.9rem; color: #666;">Minimo</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.8rem; font-weight: bold; color: #2563eb;">€${player.prezzi.avg}</div>
                                <div style="font-size: 0.9rem; color: #666;">Consenso</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #28a745;">€${player.prezzi.max}</div>
                                <div style="font-size: 0.9rem; color: #666;">Massimo</div>
                            </div>
                        </div>
                        <div class="price-analysis">
            `;

            // Show all source prices
            Object.entries(player.allPrices).forEach(([source, price]) => {
                const cleanSource = source.replace(/_\d{4}/, '').replace('_', ' ').toUpperCase();
                detailsHtml += `
                    <div class="source-price">
                        <div class="source-name">${cleanSource}</div>
                        <div class="source-value">€${price}</div>
                    </div>
                `;
            });

            detailsHtml += `
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-title">📊 Statistiche Essenziali</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <strong>Titolarità:</strong> ${getReliabilityStars(player.stats.t)} (${player.stats.t}/5)
                            </div>
                            <div>
                                <strong>Affidabilità:</strong> ${getReliabilityStars(player.stats.a)} (${player.stats.a}/5)
                            </div>
                            <div>
                                <strong>Integrità:</strong> ${getReliabilityStars(player.stats.i)} (${player.stats.i}/5)
                            </div>
                            <div>
                                <strong>FMV:</strong> ${player.stats.f || 'N/A'}
                            </div>
                        </div>
                    </div>
            `;

            // Role-specific advanced stats
            if (role === 'C' || role === 'A') {
                detailsHtml += `
                    <div class="detail-section">
                        <div class="detail-title">⚽ Performance</div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div><strong>Gol:</strong> ${player.performance?.g || 0}</div>
                            <div><strong>Assist:</strong> ${player.performance?.as || 0}</div>
                            <div><strong>Presenze:</strong> ${player.performance?.p || 0}</div>
                            <div><strong>Rigoristi:</strong> ${player.performance?.rs || 0}</div>
                            <div><strong>Media Voto:</strong> ${player.performance?.mv || 'N/A'}</div>
                            <div><strong>FMV Exp:</strong> ${player.performance?.fexp || 'N/A'}</div>
                        </div>
                    </div>
                `;
            }

            detailsHtml += `
                    <div class="detail-section">
                        <div class="detail-title">🎯 Raccomandazione AI</div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; border-left: 4px solid #2563eb;">
                            <strong>Ideale:</strong> €${priceHints.ideal}<br>
                            <strong>Suggerito:</strong> €${priceHints.suggested}<br>
                            <strong>Massimo:</strong> €${priceHints.max}<br>
                            <strong>Opportunità:</strong> ${getOpportunityLevel(player).toUpperCase()}<br>
                            <strong>Strategia:</strong> ${getOpportunityLevel(player) === 'high' ? 'Punta al prezzo minimo, alta volatilità' : 'Prezzo stabile, offri vicino al consenso'}
                        </div>
                    </div>
                </div>
            `;

            detailsContainer.innerHTML = detailsHtml;
            modal.style.display = 'flex';
        }

        // Add loading completion
        setTimeout(() => {
            document.querySelector('.loading')?.remove();
        }, 1000);
    </script>
</body>
</html>
