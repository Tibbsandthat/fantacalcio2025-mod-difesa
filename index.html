<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantacalcio 2025 - Ultra Intelligence</title>
    <!-- Optional: load Font Awesome for custom coin icon -->
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"> -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --color-primary: #2563eb;
            --color-secondary: #9333ea;
            --color-success: #22c55e;
            --color-warning: #facc15;
            --text-color: #f1f5f9;
            --text-muted: #94a3b8;
            --card-bg: #2a2a36;
            --font-sm: 12px;
            --font-base: 14px;
            --font-lg: 18px;
            --radius: 16px;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            height: 100vh;
            min-height: 100dvh;
            color: var(--text-color);
            padding: 20px;
            font-size: var(--font-base);
            line-height: 1.3;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--radius);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .nav-tabs {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .nav-btn {
            padding: 8px 16px;
            border-radius: var(--radius);
            border: 1px solid var(--color-primary);
            background: transparent;
            color: var(--color-primary);
            cursor: pointer;
            min-width: 44px;
            min-height: 44px;
        }

        .nav-btn.active {
            background: var(--color-primary);
            color: #fff;
            font-weight: 600;
        }

        #targets-view {
            display: none;
            padding: clamp(10px, 4vw, 30px);
        }

        .search-container {
            padding: clamp(10px, 4vw, 30px);
            background: var(--card-bg);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .search-box {
            position: relative;
            max-width: 600px;
            margin: 0 auto;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            font-size: var(--font-base);
            border: 2px solid var(--color-primary);
            border-radius: var(--radius);
            outline: none;
            background: transparent;
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: var(--color-secondary);
            box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.3);
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--color-primary);
            background: transparent;
            color: var(--color-primary);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: var(--font-base);
            min-width: 44px;
            min-height: 44px;
        }

        .filter-btn.active {
            background: var(--color-primary);
            color: #fff;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            padding: clamp(10px, 4vw, 30px);
        }

        .players-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        }

        @media (max-width: 768px) {
            .players-grid {
                gap: 8px;
                grid-template-columns: 1fr;
            }
        }

        .role-section {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: clamp(10px, 4vw, 30px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            color: var(--text-color);
        }

        .role-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }

        .role-icon {
            font-size: 2rem;
            margin-right: 15px;
        }

        .role-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .role-count {
            margin-left: auto;
            background: var(--color-primary);
            color: #fff;
            padding: 5px 12px;
            border-radius: var(--radius);
            font-size: var(--font-base);
        }

        .player-card {
            display: flex;
            align-items: center;
            padding: 6px 10px;
            background: var(--card-bg);
            border-radius: var(--radius);
            margin-bottom: 4px;
            transition: all 0.3s ease;
            cursor: pointer;
            border-left: 4px solid transparent;
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }

        .player-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            border-left-color: var(--color-primary);
        }

        .player-card.bought {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .player-card.bought-elsewhere {
            opacity: 0.6;
        }

        .player-actions {
            display: flex;
            gap: 4px;
            margin-left: 8px;
        }

        .action-btn {
            border: none;
            background: var(--color-primary);
            color: #fff;
            padding: 8px;
            border-radius: var(--radius);
            font-size: var(--font-base);
            cursor: pointer;
            min-width: 44px;
            min-height: 44px;
        }

        .purchase-badge {
            background: var(--color-success);
            color: #fff;
            padding: 2px 6px;
            border-radius: var(--radius);
            font-size: var(--font-sm);
            margin-left: 4px;
            display: inline-block;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-size: var(--font-lg);
            margin-bottom: 2px;
            color: var(--text-color);
            font-weight: 600;
        }

        .player-team {
            color: var(--text-muted);
            font-size: var(--font-sm);
            margin-bottom: 2px;
        }

        .player-stats {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            line-height: 1.2;
        }

        .stat-badge {
            background: var(--color-primary);
            padding: 2px 4px;
            border-radius: var(--radius);
            font-size: var(--font-sm);
            color: var(--text-color);
        }

        .stat-badge.excellent { background: var(--color-success); }
        .stat-badge.good { background: var(--color-warning); color: #000; }
        .stat-badge.average { background: var(--color-primary); }

        .smart-price {
            font-size: var(--font-lg);
            font-weight: 600;
            margin-bottom: 2px;
            color: inherit;
        }

        .price-range {
            font-size: var(--font-sm);
            color: inherit;
        }

        .price-badge {
            margin-left: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: fit-content;
            padding: 4px 8px;
            border-radius: var(--radius);
            background: var(--color-primary);
            color: var(--text-color);
            text-align: center;
        }

        .coin-icon {
            display: inline-block;
            margin-left: 2px;
        }

        .opportunity-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--color-success);
            color: #fff;
            padding: 2px 6px;
            border-radius: var(--radius);
            font-size: var(--font-sm);
            font-weight: 600;
        }

        .sidebar {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: clamp(10px, 4vw, 30px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
            color: var(--text-color);
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            color: var(--text-color);
        }

        .sidebar-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .sidebar-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-color);
        }

        .quick-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .quick-stat {
            text-align: center;
            padding: 15px;
            background: var(--card-bg);
            border-radius: var(--radius);
        }

        .quick-stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--color-primary);
        }

        .quick-stat-label {
            font-size: var(--font-base);
            color: var(--text-muted);
            margin-top: 5px;
        }

        .recommendations {
            list-style: none;
        }

        .recommendation {
            padding: 12px;
            background: var(--card-bg);
            border-radius: var(--radius);
            margin-bottom: 10px;
            border-left: 3px solid var(--color-success);
        }

        .recommendation-text {
            font-size: var(--font-base);
            color: var(--text-color);
        }

        .recommendation-price {
            font-weight: 600;
            color: var(--color-success);
            margin-top: 3px;
        }

        .planner-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .planner-row {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .planner-row.collapsed {
            gap: 0;
        }

        .planner-header {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .slot-summary {
            margin-left: auto;
            font-size: var(--font-sm);
            color: var(--text-muted);
        }

        .planner-row.collapsed .slots-planner {
            display: none;
        }

        .planner-role {
            font-weight: 600;
            width: 30px;
            text-align: center;
        }

        .flex-wrap {
            display: flex;
            flex: 1;
            gap: 10px;
            flex-wrap: wrap;
        }

        .surface {
            padding: 8px;
            background: var(--card-bg);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius);
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .slots-planner {
            /* uses flex-wrap and surface utilities */
        }

        .slot {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .slot-label {
            font-size: var(--font-sm);
            color: var(--text-muted);
        }

        .input-field {
            width: 60px;
            min-width: 44px;
            min-height: 44px;
            padding: 8px;
            border: 2px solid var(--color-primary);
            border-radius: var(--radius);
            background: var(--card-bg);
            color: var(--text-color);
            transition: background 0.2s, box-shadow 0.2s, border-color 0.2s;
        }

        .input-field:hover,
        .input-field:focus {
            border-color: var(--color-secondary);
            box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.3);
            outline: none;
        }

        .input-field,
        #strategy-P,
        #strategy-D,
        #strategy-C,
        #strategy-A {
            -webkit-appearance: none;
            margin: 0;
        }

        @media (max-width: 600px) {
            .planner-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .planner-role {
                width: auto;
                margin-bottom: 8px;
            }

            .slots-planner {
                width: 100%;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.2);
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-wrap: wrap;
            }

            .nav-btn {
                padding: 6px 14px;
                font-size: 0.9rem;
            }
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: clamp(10px, 4vw, 30px);
            }

            .sidebar {
                order: -1;
                position: static;
            }
        }

        @media (max-width: 480px) {
            .nav-tabs {
                gap: 6px;
            }

            .nav-btn {
                padding: 4px 12px;
                font-size: 0.85rem;
            }
            .filters {
                gap: 6px;
            }
            .main-content {
                gap: 20px;
            }
        }

        .advanced-filters {
            background: var(--card-bg);
            padding: clamp(10px, 4vw, 30px);
            border-radius: var(--radius);
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .filter-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 150px;
        }

        .filter-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-muted);
        }

        .filter-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--color-primary);
            border-radius: var(--radius);
            background: transparent;
            color: var(--text-color);
            min-height: 44px;
        }

        .price-range-slider {
            margin-top: 10px;
        }

        .range-input {
            width: 100%;
            margin-bottom: 5px;
            height: 44px;
        }

        .slot-select {
            border: 1px solid var(--color-primary);
            border-radius: var(--radius);
            background: transparent;
            color: var(--text-color);
            min-height: 44px;
        }

        .range-values {
            display: flex;
            justify-content: space-between;
            font-size: var(--font-base);
            color: var(--text-muted);
        }

        .ai-insights {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            color: #fff;
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 20px;
        }

        .insight-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .insight-text {
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100vh;
            min-height: 100dvh;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: 0;
            padding: 30px;
            border-radius: var(--radius);
            width: 90%;
            max-width: 600px;
            height: auto;
            max-height: calc(100dvh - 2rem);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            color: var(--text-color);
        }

        .close {
            color: var(--text-muted);
            float: right;
            font-size: 28px;
            font-weight: 600;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: var(--text-color);
        }

        .player-details {
            display: grid;
            gap: 20px;
        }

        .detail-section {
            background: var(--card-bg);
            padding: 15px;
            border-radius: var(--radius);
        }

        .detail-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .price-analysis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .source-price {
            text-align: center;
            padding: 10px;
            background: var(--card-bg);
            border-radius: var(--radius);
            border: 1px solid var(--color-primary);
        }

        .source-name {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .source-value {
            font-weight: 600;
            color: var(--color-primary);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-tabs">
            <button id="nav-home" class="nav-btn active">Lista</button>
            <button id="nav-targets" class="nav-btn">Targets</button>
        </div>
        <div id="main-view">
        <div class="search-container">
            <div class="search-box">
                <input type="text" class="search-input" placeholder="üîç Cerca giocatori... (nome, team, stats)"
                       id="search-input">
            </div>
            <div class="filters" id="role-filters">
                <button class="filter-btn active" data-role="all">Tutti</button>
                <button class="filter-btn" data-role="P">ü•Ö Portieri</button>
                <button class="filter-btn" data-role="D">üõ°Ô∏è Difensori</button>
                <button class="filter-btn" data-role="C">‚ö° Centrocampisti</button>
                <button class="filter-btn" data-role="A">‚öîÔ∏è Attaccanti</button>
            </div>
        </div>
        <div class="main-content">
            <div class="players-section">
                <div class="advanced-filters">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label class="filter-label">Fascia di Prezzo</label>
                            <select class="filter-select" id="price-filter">
                                <option value="all">Tutte le fasce</option>
                                <option value="top">Top (40+)</option>
                                <option value="semitop">Semitop (20-40)</option>
                                <option value="mid">Media (10-20)</option>
                                <option value="low">Low Cost (1-10)</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Affidabilit√†</label>
                            <select class="filter-select" id="reliability-filter">
                                <option value="all">Tutte</option>
                                <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
                                <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
                                <option value="3">‚≠ê‚≠ê‚≠ê</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Opportunit√†</label>
                            <select class="filter-select" id="opportunity-filter">
                                <option value="all">Tutte</option>
                                <option value="high">üî• Alta</option>
                                <option value="medium">üìà Media</option>
                                <option value="low">‚öñÔ∏è Equilibrio</option>
                            </select>
                        </div>
                    </div>
                    <div class="price-range-slider">
                        <label class="filter-label">Range di Prezzo</label>
                        <input type="range" class="range-input" id="min-price" min="1" max="200" value="1" step="1">
                        <input type="range" class="range-input" id="max-price" min="1" max="200" value="200" step="1">
                        <div class="range-values">
                            <span id="min-price-val">1</span>
                            <span id="max-price-val">200</span>
                        </div>
                    </div>
                </div>

                <div class="players-grid" id="players-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        Caricamento database intelligente...
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="sidebar-section">
                    <div class="sidebar-title">üí∞ Budget</div>
                    <button id="open-strategy" class="action-btn" style="width: 100%; margin-top: 10px;">üìê Strategia</button>
                    <div id="strategy-container" style="display: none; margin-top: 10px;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px;">
                            <label>P: <input type="number" id="strategy-P" min="0" max="100" style="width:60px;"></label>
                            <label>D: <input type="number" id="strategy-D" min="0" max="100" style="width:60px;"></label>
                            <label>C: <input type="number" id="strategy-C" min="0" max="100" style="width:60px;"></label>
                            <label>A: <input type="number" id="strategy-A" min="0" max="100" style="width:60px;"></label>
                        </div>
                        <button id="save-strategy" class="action-btn" style="width:100%;">Salva</button>
                    </div>
                    <ul class="recommendations">
                        <li>Totale: <span id="budget-total">0</span>/<span id="budget-total-max">500</span></li>
                        <li>P: <span id="budget-P">0</span>/<span id="budget-P-max">50</span> (<span id="count-P">0</span>/<span id="needed-P">3</span>)</li>
                        <li>D: <span id="budget-D">0</span>/<span id="budget-D-max">160</span> (<span id="count-D">0</span>/<span id="needed-D">8</span>)</li>
                        <li>C: <span id="budget-C">0</span>/<span id="budget-C-max">150</span> (<span id="count-C">0</span>/<span id="needed-C">8</span>)</li>
                        <li>A: <span id="budget-A">0</span>/<span id="budget-A-max">140</span> (<span id="count-A">0</span>/<span id="needed-A">6</span>)</li>
                    </ul>
                </div>

                <details class="sidebar-card">
                    <summary class="sidebar-card-title">ü§ñ AI Insights</summary>
                    <div class="insight-text" id="ai-insight">
                        Analizzando le tendenze di mercato e le performance storiche...
                    </div>
                </details>

                <details class="sidebar-card" open>
                    <summary class="sidebar-card-title">üíé Opportunit√† Top</summary>
                    <ul class="recommendations" id="top-opportunities">
                        <li class="recommendation">
                            <div class="recommendation-text">Caricamento opportunit√†...</div>
                        </li>
                    </ul>
                </details>
            </div>
        </div>
        </div>

        <div id="targets-view">
            <button id="targets-back" class="nav-btn" style="margin-bottom:10px;">‚¨ÖÔ∏è Back</button>
            <h2 style="text-align:center; margin:20px 0;">Squad Planner</h2>
            <div class="planner-container" id="squad-planner"></div>
            <div class="players-grid" id="targets-grid"></div>
        </div>
    </div>

    <!-- Player Detail Modal -->
    <div id="player-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <button id="modal-back" class="nav-btn" style="margin:10px 0;">‚¨ÖÔ∏è Back</button>
            <div id="player-details"></div>
        </div>
    </div>

    <script>
        // üî• DYNAMIC ULTRA-INTELLIGENT DATABASE
        let PLAYERS_DB = {};
        // Global variables
        let currentRole = 'all';
        let searchTerm = '';
        let currentFilters = {
            price: 'all',
            reliability: 'all',
            opportunity: 'all',
            minPrice: 1,
            maxPrice: 200
        };

        // Budget and target tracking
        const budget = {
            total: { max: 500, spent: 0 },
            roles: {
                'P': { max: 50, spent: 0, count: 0, needed: 3 },
                'D': { max: 160, spent: 0, count: 0, needed: 8 },
                'C': { max: 150, spent: 0, count: 0, needed: 8 },
                'A': { max: 140, spent: 0, count: 0, needed: 6 }
            }
        };
        const strategy = {};
        const targets = JSON.parse(localStorage.getItem('targets') || '{}');
        const purchased = {};
        const others = {};
        const slotConfig = { 'P': 4, 'D': 4, 'C': 4, 'A': 4 };
        const slotPlan = {};
        const slotPurchases = {};
        Object.entries(slotConfig).forEach(([role, count]) => {
            slotPlan[role] = {};
            slotPurchases[role] = {};
            for (let i = 1; i <= count; i++) {
                const slot = i.toString();
                slotPlan[role][slot] = 0;
                slotPurchases[role][slot] = 0;
            }
        });

        function getRoleSlots(role) {
            return Object.keys(slotPlan[role] || {});
        }

        function getAllSlots() {
            const set = new Set();
            Object.values(slotPlan).forEach(r => Object.keys(r).forEach(s => set.add(s)));
            return Array.from(set).sort((a, b) => Number(a) - Number(b));
        }

        function loadPurchased() {
            const saved = JSON.parse(localStorage.getItem('purchased') || '{}');
            Object.entries(saved).forEach(([key, data]) => {
                const [role, name] = key.split(':');
                const roleSlots = getRoleSlots(role);
                const slot = data.slot || targets[key]?.slot || roleSlots[roleSlots.length - 1];
                const price = Math.round(data.price);
                purchased[key] = { ...data, slot, price };
                budget.total.spent += price;
                budget.roles[role] = budget.roles[role] || { spent: 0, count: 0 };
                budget.roles[role].spent += price;
                budget.roles[role].count += 1;
                slotPurchases[role][slot] = (slotPurchases[role][slot] || 0) + 1;
                targets[key] = targets[key] || { name, role, price, slot };
                targets[key].slot = targets[key].slot || slot;
                targets[key].price = price;
            });
            const othersSaved = JSON.parse(localStorage.getItem('others') || '{}');
            Object.entries(othersSaved).forEach(([key, data]) => {
                const [role, name] = key.split(':');
                others[key] = { name, role };
            });
            savePurchased();
            saveOthers();
        }

        function savePurchased() {
            localStorage.setItem('purchased', JSON.stringify(purchased));
        }

        function saveOthers() {
            localStorage.setItem('others', JSON.stringify(others));
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            history.replaceState({ view: 'main' }, '');
            loadPurchased();
            updateBudgetUI();
            updateTargetsUI();
            const playersGrid = document.getElementById('players-grid');
            fetch('players_database.json')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    PLAYERS_DB = data;
                    initializeApp();
                    setupEventListeners();
                    renderPlayers();
                    generateAIInsights();
                })
                .catch(error => {
                    console.error('Error loading player database:', error);
                    if (playersGrid) {
                        playersGrid.innerHTML = '<div class="error">Errore nel caricamento dei dati</div>';
                    }
                });
        });

        function initializeApp() {
            // Calculate total players
            const totalPlayers = Object.values(PLAYERS_DB).reduce((sum, role) => sum + role.length, 0);
            const totalEl = document.getElementById('total-players');
            if (totalEl) totalEl.textContent = totalPlayers;

            // Initialize range sliders
            const minPrice = document.getElementById('min-price');
            const maxPrice = document.getElementById('max-price');
            if (!minPrice || !maxPrice) return;
            minPrice.addEventListener('input', updatePriceRange);
            maxPrice.addEventListener('input', updatePriceRange);

            for (const role of ['P','D','C','A']) {
                strategy[role] = Math.round((budget.roles[role].max / budget.total.max) * 100);
                const input = document.getElementById(`strategy-${role}`);
                if (!input) return;
                input.value = strategy[role];
            }

            updateBudgetUI();
            updateTargetsUI();
            renderPlayers();
        }

        function setupEventListeners() {
            // Search input
            document.getElementById('search-input').addEventListener('input', handleSearch);
            
            // Role filters
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', handleRoleFilter);
            });
            
            // Advanced filters
            document.getElementById('price-filter').addEventListener('change', handleAdvancedFilter);
            document.getElementById('reliability-filter').addEventListener('change', handleAdvancedFilter);
            document.getElementById('opportunity-filter').addEventListener('change', handleAdvancedFilter);
            
            // Modal
            const modal = document.getElementById('player-modal');
            const closeModal = modal.querySelector('.close');
            closeModal.addEventListener('click', () => history.back());
            const modalBack = document.getElementById('modal-back');
            modalBack.addEventListener('click', () => history.back());

            window.addEventListener('click', (e) => {
                if (e.target === modal) history.back();
            });

            const targetsBack = document.getElementById('targets-back');
            targetsBack.addEventListener('click', () => history.back());

            renderSquadPlanner();
            setupSquadPlanner();
        }

        function renderSquadPlanner() {
            const planner = document.getElementById('squad-planner');
            if (!planner) return;
            planner.innerHTML = '';
            Object.keys(slotPlan).forEach(role => {
                const row = document.createElement('div');
                row.className = 'role-section planner-row';
                row.dataset.role = role;

                const header = document.createElement('div');
                header.className = 'planner-header';

                const roleDiv = document.createElement('div');
                roleDiv.className = 'planner-role';
                roleDiv.textContent = role;
                header.appendChild(roleDiv);

                const summary = document.createElement('div');
                summary.className = 'slot-summary';
                summary.id = `slot-summary-${role}`;
                summary.textContent = getSlotSummaryText(role);
                header.appendChild(summary);

                row.appendChild(header);

                const slotsDiv = document.createElement('div');
                slotsDiv.className = 'slots-planner flex-wrap surface';
                getRoleSlots(role).forEach(slot => {
                    const slotDiv = document.createElement('div');
                    slotDiv.className = 'slot';

                    const label = document.createElement('span');
                    label.className = 'slot-label';
                    label.textContent = slot;
                    slotDiv.appendChild(label);

                    const input = document.createElement('input');
                    input.type = 'number';
                    input.className = 'slot-input input-field';
                    input.id = `slot-plan-${role}-${slot}`;
                    input.min = '0';
                    input.value = slotPlan[role][slot];
                    slotDiv.appendChild(input);

                    const small = document.createElement('small');
                    small.id = `slot-count-${role}-${slot}`;
                    small.textContent = `${slotPurchases[role][slot]}/${slotPlan[role][slot]}`;
                    slotDiv.appendChild(small);

                    slotsDiv.appendChild(slotDiv);
                });

                row.appendChild(slotsDiv);
                planner.appendChild(row);
            });
        }

        function getSlotSummaryText(role) {
            return getRoleSlots(role)
                .map(slot => `${slotPurchases[role][slot]}/${slotPlan[role][slot]}`)
                .join(' - ');
        }

        function updateSlotSummary(role) {
            const summary = document.getElementById(`slot-summary-${role}`);
            if (summary) {
                summary.textContent = getSlotSummaryText(role);
            }
        }

        function setupSquadPlanner() {
            Object.keys(slotPlan).forEach(role => {
                const row = document.querySelector(`.planner-row[data-role="${role}"]`);
                const header = row?.querySelector('.planner-header');
                header?.addEventListener('click', () => {
                    const isCollapsed = row.classList.contains('collapsed');
                    document.querySelectorAll('.planner-row').forEach(r => r.classList.add('collapsed'));
                    if (isCollapsed) row.classList.remove('collapsed');
                });

                getRoleSlots(role).forEach(slot => {
                    const input = document.getElementById(`slot-plan-${role}-${slot}`);
                    if (input) {
                        input.addEventListener('input', e => {
                            slotPlan[role][slot] = parseInt(e.target.value) || 0;
                            updateBudgetUI();
                            updateTargetsUI();
                        });
                    }
                });
            });

            if (window.matchMedia('(max-width: 600px)').matches) {
                document.querySelectorAll('.planner-row').forEach(row => row.classList.add('collapsed'));
            }
        }

        // Strategy inputs toggle
        const strategyContainer = document.getElementById('strategy-container');
        document.getElementById('open-strategy').addEventListener('click', () => {
            if (strategyContainer.style.display === 'none' || strategyContainer.style.display === '') {
                strategyContainer.style.display = 'block';
            } else {
                strategyContainer.style.display = 'none';
            }
        });
        document.getElementById('save-strategy').addEventListener('click', saveStrategy);

        // Navigation
        document.getElementById('nav-home').addEventListener('click', showMainView);
        document.getElementById('nav-targets').addEventListener('click', showTargetsView);

        function handleSearch(e) {
            searchTerm = e.target.value.toLowerCase();
            renderPlayers();
        }

        function handleRoleFilter(e) {
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            
            currentRole = e.target.dataset.role;
            renderPlayers();
        }

        function handleAdvancedFilter() {
            currentFilters.price = document.getElementById('price-filter').value;
            currentFilters.reliability = document.getElementById('reliability-filter').value;
            currentFilters.opportunity = document.getElementById('opportunity-filter').value;
            renderPlayers();
        }

        function showMainView(push = true) {
            document.getElementById('main-view').style.display = 'block';
            document.getElementById('targets-view').style.display = 'none';
            document.getElementById('nav-home').classList.add('active');
            document.getElementById('nav-targets').classList.remove('active');
            renderPlayers();
            if (push) history.pushState({ view: 'main' }, '');
        }

        function showTargetsView(push = true) {
            document.getElementById('main-view').style.display = 'none';
            document.getElementById('targets-view').style.display = 'block';
            document.getElementById('nav-home').classList.remove('active');
            document.getElementById('nav-targets').classList.add('active');
            updateTargetsUI();
            if (push) history.pushState({ view: 'targets' }, '');
        }

        function updatePriceRange() {
            const minPrice = parseInt(document.getElementById('min-price').value);
            const maxPrice = parseInt(document.getElementById('max-price').value);
            
            // Ensure min doesn't exceed max
            if (minPrice > maxPrice) {
                document.getElementById('min-price').value = maxPrice;
                currentFilters.minPrice = maxPrice;
            } else {
                currentFilters.minPrice = minPrice;
            }
            
            currentFilters.maxPrice = maxPrice;
            
            document.getElementById('min-price-val').textContent = currentFilters.minPrice;
            document.getElementById('max-price-val').textContent = currentFilters.maxPrice;
            
            renderPlayers();
        }

        function decodePlayer(playerArray, role) {
            if (!Array.isArray(playerArray)) return playerArray;
            const baseData = {
                nome: playerArray[0],
                team: playerArray[1],
                prezzi: {
                    min: Math.round(playerArray[2][0]),
                    max: Math.round(playerArray[2][1]),
                    avg: Math.round(playerArray[2][2])
                },
                stats: playerArray[3]
            };

            if (role === 'P' || role === 'D') {
                baseData.advanced = playerArray[4];
                if (playerArray.length >= 9) {
                    baseData.performance = playerArray[5];
                    baseData.fascia = playerArray[6];
                    baseData.notes = playerArray[7] || {};
                    baseData.allPrices = playerArray[8];
                } else {
                    baseData.fascia = playerArray[5];
                    baseData.allPrices = playerArray[6];
                }
            } else if (role === 'C' || role === 'A') {
                baseData.performance = playerArray[4];
                baseData.discipline = playerArray[5];
                baseData.fascia = playerArray[6];
                baseData.notes = playerArray[7] || {};
                baseData.allPrices = playerArray[8];
            }

            return baseData;
        }

        function filterPlayers(players, role) {
            return players.filter(playerArray => {
                const player = decodePlayer(playerArray, role);
                const key = `${role}:${player.nome}`;
                if (targets[key]) return false;

                // Search filter
                if (searchTerm) {
                    const searchStr = `${player.nome} ${player.team}`.toLowerCase();
                    if (!searchStr.includes(searchTerm)) return false;
                }
                
                // Price range filter
                const avgPrice = player.prezzi.avg;
                if (avgPrice < currentFilters.minPrice || avgPrice > currentFilters.maxPrice) return false;
                
                // Price tier filter
                if (currentFilters.price !== 'all') {
                    const priceMatches = {
                        'top': avgPrice >= 40,
                        'semitop': avgPrice >= 20 && avgPrice < 40,
                        'mid': avgPrice >= 10 && avgPrice < 20,
                        'low': avgPrice < 10
                    };
                    if (!priceMatches[currentFilters.price]) return false;
                }
                
                // Reliability filter
                if (currentFilters.reliability !== 'all') {
                    const reliability = player.stats.a || 3;
                    if (reliability !== parseInt(currentFilters.reliability)) return false;
                }
                
                // Opportunity filter (based on price variance)
                if (currentFilters.opportunity !== 'all') {
                    const variance = ((player.prezzi.max - player.prezzi.min) / player.prezzi.avg) * 100;
                    const opportunityMatches = {
                        'high': variance > 20,
                        'medium': variance >= 10 && variance <= 20,
                        'low': variance < 10
                    };
                    if (!opportunityMatches[currentFilters.opportunity]) return false;
                }
                
                return true;
            });
        }

        function getOpportunityLevel(player) {
            const variance = ((player.prezzi.max - player.prezzi.min) / player.prezzi.avg) * 100;
            if (variance > 20) return 'high';
            if (variance >= 10) return 'medium';
            return 'low';
        }

        function getReliabilityStars(reliability) {
            return '‚≠ê'.repeat(reliability || 3);
        }

        function formatStatBadge(value, thresholds = [4, 3]) {
            if (value >= thresholds[0]) return 'excellent';
            if (value >= thresholds[1]) return 'good';
            return 'average';
        }

        function findPlayer(name, role) {
            const players = PLAYERS_DB[role] || [];
            const playerArray = players.find(p => p[0] === name);
            return playerArray ? decodePlayer(playerArray, role) : null;
        }

        function calculateTargetPrices(player, role) {
            const roleData = budget.roles[role];
            const remainingBudget = roleData.max - roleData.spent;
            const remainingSlots = roleData.needed - roleData.count;
            const perSlot = remainingSlots > 0 ? Math.floor(remainingBudget / remainingSlots) : 0;
            return {
                ideal: Math.round(Math.min(player.prezzi.min, perSlot)),
                suggested: Math.round(Math.min(player.prezzi.avg, perSlot)),
                max: Math.round(Math.min(player.prezzi.max, remainingBudget))
            };
        }

        function updateSmartPricing() {
            const remainingTotal = budget.total.max - budget.total.spent;
            ['P','D','C','A'].forEach(role => {
                budget.roles[role].max = budget.roles[role].spent + Math.round(remainingTotal * (strategy[role] || 0) / 100);
            });
            Object.keys(targets).forEach(key => {
                const t = targets[key];
                const player = findPlayer(t.name, t.role);
                if (player) {
                    t.prices = calculateTargetPrices(player, t.role);
                }
            });
            updateBudgetUI();
            updateTargetsUI();
            renderPlayers();
        }

        function saveStrategy() {
            const total = budget.total.max;
            let newTotal = 0;
            ['P','D','C','A'].forEach(role => {
                const val = parseInt(document.getElementById(`strategy-${role}`).value) || 0;
                strategy[role] = val;
                const roleMax = Math.round(total * val / 100);
                budget.roles[role].max = roleMax;
                newTotal += roleMax;
            });
            budget.total.max = newTotal;
            updateBudgetUI();
            updateSmartPricing();
            strategyContainer.style.display = 'none';
        }

        function updateBudgetUI() {
            document.getElementById('budget-total').textContent = budget.total.spent;
            document.getElementById('budget-total-max').textContent = budget.total.max;
            ['P','D','C','A'].forEach(role => {
                document.getElementById(`budget-${role}`).textContent = budget.roles[role].spent;
                document.getElementById(`budget-${role}-max`).textContent = budget.roles[role].max;
                document.getElementById(`count-${role}`).textContent = budget.roles[role].count;
                document.getElementById(`needed-${role}`).textContent = budget.roles[role].needed;
                getRoleSlots(role).forEach(slot => {
                    const span = document.getElementById(`slot-count-${role}-${slot}`);
                    if (span) {
                        span.textContent = `${slotPurchases[role][slot]}/${slotPlan[role][slot]}`;
                    }
                });
                updateSlotSummary(role);
            });
        }

        function getRemainingSlotQuota(role, slot) {
            return Math.max((slotPlan[role][slot] || 0) - (slotPurchases[role][slot] || 0), 0);
        }

        function checkSlotAlert(role, slot) {
            if (getRemainingSlotQuota(role, slot) <= 0) {
                alert(`Quota slot ${slot} per ruolo ${role} raggiunta`);
            }
        }

        function calculateSlotBudgets() {
            const slotBudgets = {};
            ['P','D','C','A'].forEach(role => {
                slotBudgets[role] = {};
                const total = Object.values(slotPlan[role]).reduce((a, b) => a + parseInt(b || 0), 0);
                getRoleSlots(role).forEach(slot => {
                    slotBudgets[role][slot] = total ? budget.roles[role].max * (slotPlan[role][slot] || 0) / total : 0;
                });
            });

            Object.values(targets).forEach(t => {
                const slotBudget = slotBudgets[t.role]?.[t.slot] || 0;
                const plannedCount = slotPlan[t.role]?.[t.slot] || 1;
                t.targetPrice = Math.round(slotBudget / plannedCount);
            });

            return slotBudgets;
        }

        function updateTargetsUI() {
            localStorage.setItem('targets', JSON.stringify(targets));

            // Render grid (if present)
            const container = document.getElementById('targets-grid');
            if (container) {
                const roleIcons = { 'P': 'ü•Ö', 'D': 'üõ°Ô∏è', 'C': '‚ö°', 'A': '‚öîÔ∏è' };
                const grouped = { 'P': [], 'D': [], 'C': [], 'A': [] };
                Object.entries(targets).forEach(([key, t]) => {
                    grouped[t.role].push([key, t]);
                });
                let html = '';
                ['P','D','C','A'].forEach(role => {
                    if (!grouped[role].length) return;
                    html += `<h3>${roleIcons[role] ?? role}</h3>`;
                    grouped[role].forEach(([key, t]) => {
                        const purchasedInfo = purchased[key];
                        const othersInfo = others[key];
                        const price = purchasedInfo?.price ?? t.price;
                        const playerData = findPlayer(t.name, t.role);
                        const comment = playerData?.notes?.comm ? `<div class="player-comment">${playerData.notes.comm}</div>` : '';
                        const boughtClass = purchasedInfo ? 'bought' : '';
                        const externalClass = othersInfo ? 'bought-elsewhere' : '';
                        html += `
                        <div class="player-card ${boughtClass} ${externalClass}">
                            <div class="player-info">
                                <div class="player-name">${roleIcons[role] ?? ''} ${t.name}</div>
                                <div class="player-team">Ruolo: ${role} ‚Ä¢ Slot
                                    <select class="slot-select" data-key="${key}" data-role="${role}">
                                        ${getRoleSlots(role).map(s => `<option value="${s}" ${t.slot == s ? 'selected' : ''}>${s}</option>`).join('')}
                                    </select>
                                </div>
                                ${comment}
                            </div>
                            <div class="price-badge">
                                <div class="smart-price">${Math.round(price)}<span class="coin-icon">ü™ô</span></div>
                            </div>
                            <div class="player-actions">
                                <button class="action-btn" onclick="toggleTarget('${t.name}', '${role}', ${Math.round(t.price)})">‚ùå</button>
                                <button class="action-btn" onclick="editTarget('${key}')">‚úèÔ∏è</button>
                                <button class="action-btn" onclick="promptBuyPlayer('${t.name}', ${Math.round(price)}, '${role}')">üí∏</button>
                                <button class="action-btn" onclick="${othersInfo ? `unmarkBoughtElsewhere('${t.name}', '${role}')` : `markBoughtElsewhere('${t.name}', '${role}')`}">üö´</button>
                                ${purchasedInfo ? `<button class="action-btn" onclick="unbuyPlayer('${t.name}', '${role}')">üîÑ</button><span class=\"purchase-badge\">${Math.round(purchasedInfo.price)}</span>` : ''}
                            </div>
                        </div>`;
                    });
                });
                container.innerHTML = html || '<p>Nessun obiettivo selezionato</p>';
                container.querySelectorAll('.slot-select').forEach(sel => {
                    sel.addEventListener('change', e => {
                        const key = e.target.dataset.key;
                        const role = e.target.dataset.role;
                        const prevSlot = targets[key].slot;
                        const newSlot = e.target.value;
                        targets[key].slot = newSlot;
                        if (purchased[key]) {
                            slotPurchases[role][prevSlot] = Math.max((slotPurchases[role][prevSlot] || 0) - 1, 0);
                            slotPurchases[role][newSlot] = (slotPurchases[role][newSlot] || 0) + 1;
                        }
                        updateBudgetUI();
                        updateTargetsUI();
                        renderPlayers();
                    });
                });
            }

            // Render simple list (if present)
            const list = document.getElementById('target-list');
            if (list) {
                calculateSlotBudgets();
                const grouped = {};
                Object.values(targets).forEach(t => {
                    if (!grouped[t.slot]) grouped[t.slot] = [];
                    grouped[t.slot].push(t);
                });

                let html = '';
                getAllSlots().forEach(slot => {
                    const players = grouped[slot] || [];
                    const remaining = ['P','D','C','A'].map(role => `${role}:${getRemainingSlotQuota(role, slot)}`).join(' ');
                    html += `<li><strong>${slot} (${remaining})</strong></li>`;
                    players.forEach(t => {
                        const key = `${t.role}:${t.name}`;
                        const price = purchased[key]?.price ?? t.price;
                        const playerDataList = findPlayer(t.name, t.role);
                        const commentList = playerDataList?.notes?.comm ? `<div style="margin-left:10px;color:var(--text-muted);">${playerDataList.notes.comm}</div>` : '';
                            if (t.prices) {
                                html += `<li class="recommendation" style="margin-left:10px;">${t.name} (${t.role}) - I:${t.prices.ideal} S:${t.prices.suggested} M:${t.prices.max} ‚Ä¢ ${Math.round(price)}${t.targetPrice ? ` (TP: ${Math.round(t.targetPrice)})` : ''}</li>${commentList}`;
                            } else {
                                html += `<li class="recommendation" style="margin-left:10px;">${t.name} (${t.role}) - ${Math.round(price)}${t.targetPrice ? ` (TP: ${Math.round(t.targetPrice)})` : ''}</li>${commentList}`;
                            }
                    });
                });
                list.innerHTML = html;
            }
        }

        function toggleTarget(name, role, price) {
            price = Math.round(price);
            const key = `${role}:${name}`;
            if (targets[key]) {
                delete targets[key];
                if (others[key]) {
                    delete others[key];
                    saveOthers();
                }
            } else {
                const player = findPlayer(name, role);
                const roleSlots = getRoleSlots(role);
                let slot = prompt(`Seleziona slot (1-${roleSlots.length}):`, roleSlots[roleSlots.length - 1]);
                if (!roleSlots.includes(slot)) return;
                const prices = player ? calculateTargetPrices(player, role) : undefined;
                targets[key] = prices
                    ? { name, role, price, slot, prices }
                    : { name, role, price, slot };
            }
            updateTargetsUI();
            renderPlayers();
        }

        function promptBuyPlayer(name, defaultPrice, role) {
            defaultPrice = Math.round(defaultPrice);
            const input = prompt(`Prezzo pagato per ${name}?`, defaultPrice);
            const price = parseInt(input, 10);
            if (input === null || input.trim() === '' || isNaN(price)) return;
            buyPlayer(name, price, role);
        }

        function editTarget(key) {
            const target = targets[key];
            if (!target) return;
            const newPrice = prompt('Nuovo prezzo per ' + target.name, target.price);
            if (newPrice !== null && !isNaN(newPrice)) {
                target.price = parseInt(newPrice, 10);
                updateTargetsUI();
                renderPlayers();
            }
        }

        function buyPlayer(name, price, role) {
            price = Math.round(price);
            const key = `${role}:${name}`;
            if (purchased[key]) return;
            let slot = targets[key]?.slot;
            if (!slot) {
                const roleSlots = getRoleSlots(role);
                slot = prompt(`Seleziona slot per acquisto (1-${roleSlots.length}):`, roleSlots[roleSlots.length - 1]);
                if (!roleSlots.includes(slot)) slot = roleSlots[roleSlots.length - 1];
            }
            const player = findPlayer(name, role);
            const hints = player ? calculateTargetPrices(player, role) : { ideal: 0, suggested: 0 };
            purchased[key] = { name, role, price, slot };
            if (others[key]) {
                delete others[key];
                saveOthers();
            }
            budget.total.spent += price;
            budget.roles[role].spent += price;
            budget.roles[role].count += 1;
            slotPurchases[role][slot] += 1;
            updateBudgetUI();
            const el = document.getElementById(`player-${role}-${name.replace(/\s+/g,'-')}`);
            if (el) {
                el.classList.add('bought');
                const actions = el.querySelector('.player-actions');
                let badge = actions.querySelector('.purchase-badge');
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'purchase-badge';
                    actions.appendChild(badge);
                }
                badge.textContent = price;
            }
            targets[key] = targets[key] || { name, role, price, slot };
            targets[key].price = price;
            targets[key].slot = targets[key].slot || slot;
            updateTargetsUI();
            renderPlayers();
            checkAlerts(role);
            checkSlotAlert(role, slot);
            if (price < hints.ideal || price < hints.suggested) {
                updateSmartPricing();
            }
            savePurchased();
        }

        function unbuyPlayer(name, role) {
            const key = `${role}:${name}`;
            const info = purchased[key];
            if (!info) return;
            const { price, slot } = info;
            budget.total.spent -= price;
            budget.roles[role].spent -= price;
            budget.roles[role].count -= 1;
            if (slot) {
                slotPurchases[role][slot] = Math.max((slotPurchases[role][slot] || 0) - 1, 0);
            }
            delete purchased[key];
            savePurchased();
            updateBudgetUI();
            const el = document.getElementById(`player-${role}-${name.replace(/\s+/g,'-')}`);
            if (el) {
                el.classList.remove('bought');
                const actions = el.querySelector('.player-actions');
                const badge = actions.querySelector('.purchase-badge');
                if (badge) badge.remove();
            }
            updateTargetsUI();
            renderPlayers();
        }

        function markBoughtElsewhere(name, role) {
            const key = `${role}:${name}`;
            if (others[key]) return;
            others[key] = { name, role };
            saveOthers();
            const el = document.getElementById(`player-${role}-${name.replace(/\s+/g,'-')}`);
            if (el) {
                el.classList.add('bought-elsewhere');
            }
            updateTargetsUI();
            renderPlayers();
        }

        function unmarkBoughtElsewhere(name, role) {
            const key = `${role}:${name}`;
            if (!others[key]) return;
            delete others[key];
            saveOthers();
            const el = document.getElementById(`player-${role}-${name.replace(/\s+/g,'-')}`);
            if (el) {
                el.classList.remove('bought-elsewhere');
            }
            updateTargetsUI();
            renderPlayers();
        }

        function checkAlerts(role) {
            const remaining = budget.roles[role].needed - budget.roles[role].count;
            if (remaining <= 1) {
                alert(`Attenzione! Rimangono ${remaining} giocatori da acquistare nel ruolo ${role}`);
            }
        }

        function createPlayerCard(playerArray, role) {
            const player = decodePlayer(playerArray, role);
            const opportunity = getOpportunityLevel(player);
            const reliabilityStars = getReliabilityStars(player.stats.a);
            const key = `${role}:${player.nome}`;
            const purchasedInfo = purchased[key];
            const othersInfo = others[key];

            const roleIcons = {
                'P': 'ü•Ö',
                'D': 'üõ°Ô∏è',
                'C': '‚ö°',
                'A': '‚öîÔ∏è'
            };
            const boughtClass = purchasedInfo ? 'bought' : '';
            const externalClass = othersInfo ? 'bought-elsewhere' : '';

            return `
                <div class="player-card ${boughtClass} ${externalClass}" id="player-${role}-${player.nome.replace(/\s+/g,'-')}" onclick="showPlayerDetails('${playerArray[0]}', '${role}')">
                    <div style="position: relative; flex:1; display: flex; align-items: center; gap: 10px;">
                        ${opportunity === 'high' ? '<div class="opportunity-badge">üî•</div>' : ''}
                        <div class="player-info">
                            <div class="player-name">${roleIcons[role]} ${player.nome}</div>
                            <div class="player-team">${player.team} ‚Ä¢ ${player.fascia}</div>
                            <div class="player-stats">
                                <span class="stat-badge ${formatStatBadge(player.stats.t)}">
                                    Tit: ${player.stats.t || 3}/5
                                </span>
                                <span class="stat-badge ${formatStatBadge(player.stats.a)}">
                                    ${reliabilityStars}
                                </span>
                                <span class="stat-badge ${formatStatBadge(player.stats.i)}">
                                    Salute: ${player.stats.i || 3}/5
                                </span>
                                ${role === 'C' || role === 'A' ? `
                                    <span class="stat-badge ${formatStatBadge(player.performance?.g || 0, [3, 1])}">
                                        ‚öΩ ${player.performance?.g || 0}
                                    </span>
                                ` : ''}
                                ${role === 'C' || role === 'A' ? `
                                    <span class="stat-badge ${formatStatBadge(player.performance?.as || 0, [2, 1])}">
                                        üÖ∞Ô∏è ${player.performance?.as || 0}
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                        <div class="price-badge">
                            <div class="smart-price">
                                ${Math.round(player.prezzi.avg)}<span class="coin-icon">ü™ô</span>
                            </div>
                            <div class="price-range">
                                ${Math.round(player.prezzi.min)}-${Math.round(player.prezzi.max)}
                            </div>
                        </div>
                    </div>
                    <div class="player-actions">
                        <button class="action-btn" onclick="event.stopPropagation(); toggleTarget('${player.nome}', '${role}', ${Math.round(player.prezzi.avg)})">üéØ</button>
                        <button class="action-btn" onclick="event.stopPropagation(); promptBuyPlayer('${player.nome}', ${Math.round(player.prezzi.avg)}, '${role}')">üí∏</button>
                        ${purchasedInfo ? `<button class="action-btn" onclick="event.stopPropagation(); unbuyPlayer('${player.nome}', '${role}')">üîÑ</button><span class=\"purchase-badge\">${Math.round(purchasedInfo.price)}</span>` : ''}
                    </div>
                </div>
            `;
        }

        function renderPlayers() {
            const playersGrid = document.getElementById('players-grid');
            const roles = currentRole === 'all' ? ['P', 'D', 'C', 'A'] : [currentRole];
            
            let allPlayersHtml = '';
            let totalFiltered = 0;

            const roleNames = {
                'P': 'ü•Ö Portieri',
                'D': 'üõ°Ô∏è Difensori', 
                'C': '‚ö° Centrocampisti',
                'A': '‚öîÔ∏è Attaccanti'
            };

            roles.forEach(role => {
                const players = PLAYERS_DB[role] || [];
                const filteredPlayers = filterPlayers(players, role);
                totalFiltered += filteredPlayers.length;

                if (filteredPlayers.length > 0) {
                    allPlayersHtml += `
                        <div class="role-section">
                            <div class="role-header">
                                <div class="role-title">${roleNames[role]}</div>
                                <div class="role-count">${filteredPlayers.length}</div>
                            </div>
                            ${filteredPlayers.map(player => createPlayerCard(player, role)).join('')}
                        </div>
                    `;
                }
            });

            if (totalFiltered === 0) {
                allPlayersHtml = `
                    <div class="role-section">
                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <div style="font-size: 3rem; margin-bottom: 20px;">üîç</div>
                            <div style="font-size: 1.2rem; margin-bottom: 10px;">Nessun risultato trovato</div>
                            <div>Prova a modificare i filtri di ricerca</div>
                        </div>
                    </div>
                `;
            }

            playersGrid.innerHTML = allPlayersHtml;
            updateTopOpportunities();
        }

        function updateTopOpportunities() {
            const MIN_RELIABILITY = 4;
            const opportunities = [];

            Object.entries(PLAYERS_DB).forEach(([role, players]) => {
                players.forEach(playerArray => {
                    const player = decodePlayer(playerArray, role);
                    const opportunity = getOpportunityLevel(player);
                    const variance = ((player.prezzi.max - player.prezzi.min) / player.prezzi.avg) * 100;
                    const reliability = player.stats.a || 0;
                    const recentForm = player.stats.f || 0;
                    const targetPrice = Math.round(player.prezzi.min * 1.1);
                    const savings = Math.round(player.prezzi.avg - targetPrice);

                    if (opportunity === 'high' && reliability >= MIN_RELIABILITY) {
                        opportunities.push({
                            ...player,
                            role,
                            variance,
                            targetPrice,
                            reliability,
                            recentForm,
                            savings
                        });
                    }
                });
            });

            opportunities.sort((a, b) => b.savings - a.savings);

            const topOpportunitiesList = document.getElementById('top-opportunities');
            const roleIcons = { 'P': 'ü•Ö', 'D': 'üõ°Ô∏è', 'C': '‚ö°', 'A': '‚öîÔ∏è' };

                topOpportunitiesList.innerHTML = opportunities
                .filter(opp => opp.reliability >= MIN_RELIABILITY)
                .slice(0, 5)
                .map(opp => `
                <li class="recommendation" onclick="showPlayerDetails('${opp.nome}', '${opp.role}')">
                    <div class="recommendation-text">
                        ${roleIcons[opp.role]} ${opp.nome} (${opp.team})
                    </div>
                    <div class="recommendation-price">
                        Target: ${Math.round(opp.targetPrice)} crediti (Risparmio: ${Math.round(opp.savings)} crediti) ‚Ä¢ Affidabilit√†: ${opp.reliability}/5 ‚Ä¢ Forma: ${opp.recentForm.toFixed(2)}
                    </div>
                </li>
            `).join('') || '<li class="recommendation"><div class="recommendation-text">Nessuna opportunit√† con i filtri attuali</div></li>';
        }

        function generateAIInsights() {
            if (!PLAYERS_DB || Object.keys(PLAYERS_DB).length === 0) {
                document.getElementById('ai-insight').textContent = 'Analisi in corso...';
                setTimeout(generateAIInsights, 10000);
                return;
            }

            const roleIcons = { 'P': 'ü•Ö', 'D': 'üõ°Ô∏è', 'C': '‚ö°', 'A': '‚öîÔ∏è' };
            const allPlayers = Object.entries(PLAYERS_DB).flatMap(([role, arr]) =>
                arr.map(pArr => ({ ...decodePlayer(pArr, role), role }))
            );

            const highReliability = allPlayers
                .filter(p => (p.stats?.a || 0) >= 4)
                .sort((a, b) => a.prezzi.avg - b.prezzi.avg);

            const topPlayers = highReliability.slice(0, 3);
            const insightText = topPlayers.length
                ? `Giocatori affidabili a basso costo: ${topPlayers.map(p => `${roleIcons[p.role]} ${p.nome} ${Math.round(p.prezzi.avg)} crediti`).join(', ')}`
                : 'Nessun giocatore affidabile trovato.';

            document.getElementById('ai-insight').innerHTML = insightText;
            setTimeout(generateAIInsights, 10000);
        }

        function showPlayerDetails(playerName, role, push = true) {
            const players = PLAYERS_DB[role] || [];
            const playerArray = players.find(p => p[0] === playerName);
            
            if (!playerArray) return;
            
            const player = decodePlayer(playerArray, role);
            const priceHints = calculateTargetPrices(player, role);
            const modal = document.getElementById('player-modal');
            const detailsContainer = document.getElementById('player-details');

            const roleIcons = { 'P': 'ü•Ö', 'D': 'üõ°Ô∏è', 'C': '‚ö°', 'A': '‚öîÔ∏è' };
            
            let detailsHtml = `
                <h2>${roleIcons[role]} ${player.nome}</h2>
                <p style="color: var(--text-muted); margin-bottom: 20px;">${player.team} ‚Ä¢ ${player.fascia}</p>
                ${player.notes?.comm ? `<p style="margin-bottom:20px;">${player.notes.comm}</p>` : ''}
                
                <div class="player-details">
                    <div class="detail-section">
                        <div class="detail-title">üí∞ Analisi Prezzi Smart</div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 600; color: var(--color-warning);">${player.prezzi.min} crediti</div>
                                <div style="font-size: var(--font-base); color: var(--text-muted);">Minimo</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.8rem; font-weight: 600; color: var(--color-primary);">${player.prezzi.avg} crediti</div>
                                <div style="font-size: var(--font-base); color: var(--text-muted);">Consenso</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 600; color: var(--color-success);">${player.prezzi.max} crediti</div>
                                <div style="font-size: var(--font-base); color: var(--text-muted);">Massimo</div>
                            </div>
                        </div>
                        <div class="price-analysis">
            `;

            // Show all source prices (deduplicated by base source)
            const latestPrices = {};
            Object.entries(player.allPrices || {}).forEach(([source, price]) => {
                const base = source.replace(/_\d{4}/, '');
                const yearMatch = source.match(/_(\d{4})/);
                const year = yearMatch ? parseInt(yearMatch[1]) : 0;
                if (!latestPrices[base] || year > latestPrices[base].year) {
                    latestPrices[base] = { price, year };
                }
            });
            Object.entries(latestPrices).forEach(([base, info]) => {
                const cleanSource = base.replace('_', ' ').toUpperCase();
                detailsHtml += `
                    <div class="source-price">
                        <div class="source-name">${cleanSource}</div>
                        <div class="source-value">${Math.round(info.price)} crediti</div>
                    </div>
                `;
            });

            detailsHtml += `
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-title">üìä Statistiche Essenziali</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <strong>Titolarit√†:</strong> ${getReliabilityStars(player.stats.t)} (${player.stats.t}/5)
                            </div>
                            <div>
                                <strong>Affidabilit√†:</strong> ${getReliabilityStars(player.stats.a)} (${player.stats.a}/5)
                            </div>
                            <div>
                                <strong>Integrit√†:</strong> ${getReliabilityStars(player.stats.i)} (${player.stats.i}/5)
                            </div>
                            <div>
                                <strong>FMV:</strong> ${player.stats.f || 'N/A'}
                            </div>
                        </div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-title">‚è±Ô∏è Last 2 Seasons</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            ${player.performance?.["2025_26"] ? `<div><strong>2025/26:</strong> G:${player.performance["2025_26"].goals ?? player.performance["2025_26"].g ?? 0} A:${player.performance["2025_26"].assists ?? player.performance["2025_26"].as ?? 0} Min:${player.performance["2025_26"].minutes ?? player.performance["2025_26"].min ?? 0} MV:${player.performance["2025_26"].rating ?? player.performance["2025_26"].mv ?? 'N/A'}</div>` : ''}
                            ${player.performance?.["2024_25"] ? `<div><strong>2024/25:</strong> G:${player.performance["2024_25"].goals ?? player.performance["2024_25"].g ?? 0} A:${player.performance["2024_25"].assists ?? player.performance["2024_25"].as ?? 0} Min:${player.performance["2024_25"].minutes ?? player.performance["2024_25"].min ?? 0} MV:${player.performance["2024_25"].rating ?? player.performance["2024_25"].mv ?? 'N/A'}</div>` : ''}
                        </div>
                    </div>
            `;

            // Role-specific advanced stats
            if (role === 'C' || role === 'A') {
                const perf = player.performance?.["2025_26"] || {};
                detailsHtml += `
                    <div class="detail-section">
                        <div class="detail-title">‚öΩ Performance</div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div><strong>Gol:</strong> ${perf.g ?? perf.goals ?? 0}</div>
                            <div><strong>Assist:</strong> ${perf.as ?? perf.assists ?? 0}</div>
                            <div><strong>Presenze:</strong> ${perf.p ?? perf.presenze ?? 0}</div>
                            <div><strong>Rigoristi:</strong> ${perf.rs ?? 0}</div>
                            <div><strong>Media Voto:</strong> ${perf.mv ?? perf.rating ?? 'N/A'}</div>
                            <div><strong>FMV Exp:</strong> ${perf.fexp ?? 'N/A'}</div>
                        </div>
                    </div>
                `;
            }

            detailsHtml += `
                    <div class="detail-section">
                        <div class="detail-title">üéØ Raccomandazione AI</div>
                        <div style="background: var(--card-bg); padding: 15px; border-radius: var(--radius); border-left: 4px solid var(--color-primary);">
                            <strong>Ideale:</strong> ${priceHints.ideal} crediti<br>
                            <strong>Suggerito:</strong> ${priceHints.suggested} crediti<br>
                            <strong>Massimo:</strong> ${priceHints.max} crediti<br>
                            <strong>Opportunit√†:</strong> ${getOpportunityLevel(player).toUpperCase()}<br>
                            <strong>Strategia:</strong> ${getOpportunityLevel(player) === 'high' ? 'Punta al prezzo minimo, alta volatilit√†' : 'Prezzo stabile, offri vicino al consenso'}
                        </div>
                    </div>
                </div>
            `;

            detailsContainer.innerHTML = detailsHtml;
            modal.style.display = 'flex';
            if (push) history.pushState({ view: 'player', player: playerName, role }, '');
        }

        window.onpopstate = (event) => {
            const modal = document.getElementById('player-modal');
            if (event.state && event.state.view === 'player') {
                showPlayerDetails(event.state.player, event.state.role, false);
                return;
            }
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
                return;
            }
            if (event.state && event.state.view === 'targets') {
                showTargetsView(false);
            } else {
                showMainView(false);
            }
        };

        // Add loading completion
        setTimeout(() => {
            document.querySelector('.loading')?.remove();
        }, 1000);
    </script>
</body>
</html>
